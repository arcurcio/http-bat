"use strict";
// NODE
var util_1 = require('util');
// LOCAL
var ATLHelpers_1 = require('../ATLHelpers');
function runSuite(suite) {
    var execFn = suite.skip ? describe.skip : describe;
    if (suite.test) {
        var test_1 = suite.test;
        execFn(test_1.description || (test_1.method.toUpperCase() + ' ' + test_1.uri), function () {
            it(test_1.method.toUpperCase() + ' ' + test_1.uri, function (done) {
                this.timeout(test_1.timeout + 100);
                test_1
                    .requester
                    .promise
                    .then(function (response) {
                    done();
                })
                    .catch(function (err) {
                    console.error(util_1.inspect(err));
                    done(err);
                });
            });
            test_1.assertions.forEach(function (x) {
                (x.skip ? it.skip : it)(x.name, function (done) {
                    this.timeout(test_1.timeout + 100);
                    x.promise
                        .then(function (err) {
                        if (err) {
                            console.error(util_1.inspect(err));
                            done(err);
                        }
                        else
                            done();
                    })
                        .catch(function (err) {
                        console.error(util_1.inspect(err));
                        done(err);
                    });
                });
            });
        });
        return test_1.promise
            .then(function (x) { return true; })
            .catch(function (x) { return false; });
    }
    var that = this;
    var flatProm = ATLHelpers_1.flatPromise();
    if (suite.suites && Object.keys(suite.suites).length) {
        execFn(suite.name, function () {
            var results = [];
            for (var k in suite.suites) {
                results.push(runSuite(suite.suites[k]));
            }
            Promise.all(results.filter(function (x) { return !!x; }))
                .then(function (results) {
                flatProm.resolver(results.every(function (result) { return result == true; }));
            })
                .catch(function (results) {
                flatProm.resolver(false);
            });
        });
    }
    return flatProm.promise;
}
function registerMochaSuites(bat) {
    var allSuites = [];
    for (var suiteName in bat.ast.suites) {
        allSuites.push(runSuite(bat.ast.suites[suiteName]));
    }
    if (bat.ast.raml) {
        describe("RAML Coverage", function () {
            if (bat.ast.options.raml.coverage) {
                bat.coverageElements.forEach(function (x) {
                    injectMochaCoverageTests(x.resourceAssertion);
                });
            }
            Promise.all(allSuites).then(function (r) {
                bat.coverageElements.forEach(function (item) { return item.run(); });
                Promise.all(bat
                    .coverageElements
                    .map(function (x) { return x.getCoverage(); })).then(function (x) {
                    var total = x.reduce(function (prev, actual) {
                        prev.errored += actual.errored;
                        prev.total += actual.total;
                        prev.notCovered += actual.notCovered;
                        return prev;
                    }, { total: 0, errored: 0, notCovered: 0 });
                    console.log('RAMLCoverage:', util_1.inspect(total, false, 2, true));
                });
            });
        });
    }
}
exports.registerMochaSuites = registerMochaSuites;
var walkCoverageAssetion = function (assertion, level) {
    if (assertion.validationFn) {
        it(assertion.name, function (done) {
            assertion.promise.promise
                .then(function () { return done(); })
                .catch(done);
        });
    }
    if (assertion.innerAssertions.length) {
        describe(assertion.name, function () {
            this.bail(false);
            assertion.innerAssertions.forEach(function (x) { return walkCoverageAssetion(x, level + 1); });
        });
    }
};
function injectMochaCoverageTests(x) {
    x && walkCoverageAssetion(x, 0);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jaGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtb2NoYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTztBQUNQLHFCQUF3QixNQUFNLENBQUMsQ0FBQTtBQUUvQixRQUFRO0FBQ1IsMkJBQStDLGVBQWUsQ0FBQyxDQUFBO0FBSy9ELGtCQUFrQixLQUFlO0lBQy9CLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7SUFFbkQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDZixJQUFJLE1BQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBRXRCLE1BQU0sQ0FBQyxNQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsTUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsR0FBRyxHQUFHLEdBQUcsTUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZFLEVBQUUsQ0FBQyxNQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxHQUFHLEdBQUcsR0FBRyxNQUFJLENBQUMsR0FBRyxFQUFFLFVBQVUsSUFBSTtnQkFDM0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDO2dCQUNqQyxNQUFJO3FCQUNELFNBQVM7cUJBQ1QsT0FBTztxQkFDUCxJQUFJLENBQUMsVUFBQSxRQUFRO29CQUNaLElBQUksRUFBRSxDQUFDO2dCQUNULENBQUMsQ0FBQztxQkFDRCxLQUFLLENBQUMsVUFBQSxHQUFHO29CQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQzVCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDWixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMs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ZXNDb250ZW50IjpbIi8vIE5PREVcbmltcG9ydCB7IGluc3BlY3QgfSBmcm9tICd1dGlsJztcblxuLy8gTE9DQUxcbmltcG9ydCB7IEFUTFRlc3QsIEFUTFN1aXRlLCBmbGF0UHJvbWlzZSB9IGZyb20gJy4uL0FUTEhlbHBlcnMnO1xuaW1wb3J0IHsgQVRMIH0gZnJvbSAnLi4vQVRMJztcbmltcG9ydCB7IEJhdCB9IGZyb20gJy4uL2JhdCc7XG5pbXBvcnQgeyBDb3ZlcmFnZVJlc291cmNlLCBDb3ZlcmFnZUFzc2VydGlvbiB9IGZyb20gJy4uL0NvdmVyYWdlJztcblxuZnVuY3Rpb24gcnVuU3VpdGUoc3VpdGU6IEFUTFN1aXRlKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIGxldCBleGVjRm4gPSBzdWl0ZS5za2lwID8gZGVzY3JpYmUuc2tpcCA6IGRlc2NyaWJlO1xuXG4gIGlmIChzdWl0ZS50ZXN0KSB7XG4gICAgbGV0IHRlc3QgPSBzdWl0ZS50ZXN0O1xuXG4gICAgZXhlY0ZuKHRlc3QuZGVzY3JpcHRpb24gfHwgKHRlc3QubWV0aG9kLnRvVXBwZXJDYXNlKCkgKyAnICcgKyB0ZXN0LnVyaSksIGZ1bmN0aW9uICgpIHtcbiAgICAgIGl0KHRlc3QubWV0aG9kLnRvVXBwZXJDYXNlKCkgKyAnICcgKyB0ZXN0LnVyaSwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgdGhpcy50aW1lb3V0KHRlc3QudGltZW91dCArIDEwMCk7XG4gICAgICAgIHRlc3RcbiAgICAgICAgICAucmVxdWVzdGVyXG4gICAgICAgICAgLnByb21pc2VcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoaW5zcGVjdChlcnIpKTtcbiAgICAgICAgICAgIGRvbmUoZXJyKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICB0ZXN0LmFzc2VydGlvbnMuZm9yRWFjaCh4ID0+IHtcbiAgICAgICAgKHguc2tpcCA/IGl0LnNraXAgOiBpdCkoeC5uYW1lLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgIHRoaXMudGltZW91dCh0ZXN0LnRpbWVvdXQgKyAxMDApO1xuICAgICAgICAgIHgucHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oZXJyID0+IHtcbiAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoaW5zcGVjdChlcnIpKTtcbiAgICAgICAgICAgICAgICBkb25lKGVycik7XG4gICAgICAgICAgICAgIH0gZWxzZVxuICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihpbnNwZWN0KGVycikpO1xuICAgICAgICAgICAgICBkb25lKGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiB0ZXN0LnByb21pc2VcbiAgICAgIC50aGVuKHggPT4gdHJ1ZSlcbiAgICAgIC5jYXRjaCh4ID0+IGZhbHNlKTtcbiAgfVxuXG4gIGxldCB0aGF0ID0gdGhpcztcblxuICBsZXQgZmxhdFByb20gPSBmbGF0UHJvbWlzZSgpO1xuXG4gIGlmIChzdWl0ZS5zdWl0ZXMgJiYgT2JqZWN0LmtleXMoc3VpdGUuc3VpdGVzKS5sZW5ndGgpIHtcbiAgICBleGVjRm4oc3VpdGUubmFtZSwgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHJlc3VsdHMgPSBbXTtcblxuICAgICAgZm9yIChsZXQgayBpbiBzdWl0ZS5zdWl0ZXMpIHtcbiAgICAgICAgcmVzdWx0cy5wdXNoKHJ1blN1aXRlKHN1aXRlLnN1aXRlc1trXSkpO1xuICAgICAgfVxuXG4gICAgICBQcm9taXNlLmFsbChcbiAgICAgICAgcmVzdWx0cy5maWx0ZXIoeCA9PiAhIXgpXG4gICAgICApXG4gICAgICAgIC50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgICAgIGZsYXRQcm9tLnJlc29sdmVyKHJlc3VsdHMuZXZlcnkocmVzdWx0ID0+IHJlc3VsdCA9PSB0cnVlKSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChyZXN1bHRzID0+IHtcbiAgICAgICAgICBmbGF0UHJvbS5yZXNvbHZlcihmYWxzZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGZsYXRQcm9tLnByb21pc2U7XG59XG5cblxuXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJNb2NoYVN1aXRlcyhiYXQ6IEJhdCkge1xuICBsZXQgYWxsU3VpdGVzID0gW107XG5cbiAgZm9yIChsZXQgc3VpdGVOYW1lIGluIGJhdC5hc3Quc3VpdGVzKSB7XG4gICAgYWxsU3VpdGVzLnB1c2gocnVuU3VpdGUoYmF0LmFzdC5zdWl0ZXNbc3VpdGVOYW1lXSkpO1xuICB9XG5cbiAgaWYgKGJhdC5hc3QucmFtbCkge1xuICAgIGRlc2NyaWJlKFwiUkFNTCBDb3ZlcmFnZVwiLCAoKSA9PiB7XG4gICAgICBpZiAoYmF0LmFzdC5vcHRpb25zLnJhbWwuY292ZXJhZ2UpIHtcblxuICAgICAgICBiYXQuY292ZXJhZ2VFbGVtZW50cy5mb3JFYWNoKHggPT4ge1xuICAgICAgICAgIGluamVjdE1vY2hhQ292ZXJhZ2VUZXN0cyh4LnJlc291cmNlQXNzZXJ0aW9uKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIFByb21pc2UuYWxsKGFsbFN1aXRlcykudGhlbihyID0+IHtcbiAgICAgICAgYmF0LmNvdmVyYWdlRWxlbWVudHMuZm9yRWFjaChpdGVtID0+IGl0ZW0ucnVuKCkpO1xuXG4gICAgICAgIFByb21pc2UuYWxsKFxuICAgICAgICAgIGJhdFxuICAgICAgICAgICAgLmNvdmVyYWdlRWxlbWVudHNcbiAgICAgICAgICAgIC5tYXAoeCA9PiB4LmdldENvdmVyYWdlKCkpXG4gICAgICAgICkudGhlbih4ID0+IHtcbiAgICAgICAgICBsZXQgdG90YWwgPSB4LnJlZHVjZSgocHJldiwgYWN0dWFsKSA9PiB7XG4gICAgICAgICAgICBwcmV2LmVycm9yZWQgKz0gYWN0dWFsLmVycm9yZWQ7XG4gICAgICAgICAgICBwcmV2LnRvdGFsICs9IGFjdHVhbC50b3RhbDtcbiAgICAgICAgICAgIHByZXYubm90Q292ZXJlZCArPSBhY3R1YWwubm90Q292ZXJlZDtcbiAgICAgICAgICAgIHJldHVybiBwcmV2O1xuICAgICAgICAgIH0sIHsgdG90YWw6IDAsIGVycm9yZWQ6IDAsIG5vdENvdmVyZWQ6IDAgfSk7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1JBTUxDb3ZlcmFnZTonLCBpbnNwZWN0KHRvdGFsLCBmYWxzZSwgMiwgdHJ1ZSkpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG5cbmNvbnN0IHdhbGtDb3ZlcmFnZUFzc2V0aW9uID0gKGFzc2VydGlvbjogQ292ZXJhZ2VBc3NlcnRpb24sIGxldmVsOiBudW1iZXIpID0+IHtcbiAgaWYgKGFzc2VydGlvbi52YWxpZGF0aW9uRm4pIHtcbiAgICBpdChhc3NlcnRpb24ubmFtZSwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgIGFzc2VydGlvbi5wcm9taXNlLnByb21pc2VcbiAgICAgICAgLnRoZW4oKCkgPT4gZG9uZSgpKVxuICAgICAgICAuY2F0Y2goZG9uZSk7XG4gICAgfSk7XG4gIH1cbiAgaWYgKGFzc2VydGlvbi5pbm5lckFzc2VydGlvbnMubGVuZ3RoKSB7XG4gICAgZGVzY3JpYmUoYXNzZXJ0aW9uLm5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHRoaXMuYmFpbChmYWxzZSk7XG4gICAgICBhc3NlcnRpb24uaW5uZXJBc3NlcnRpb25zLmZvckVhY2goeCA9PiB3YWxrQ292ZXJhZ2VBc3NldGlvbih4LCBsZXZlbCArIDEpKTtcbiAgICB9KTtcbiAgfVxufTtcblxuZnVuY3Rpb24gaW5qZWN0TW9jaGFDb3ZlcmFnZVRlc3RzKHg6IENvdmVyYWdlQXNzZXJ0aW9uKSB7XG4gIHggJiYgd2Fsa0NvdmVyYWdlQXNzZXRpb24oeCwgMCk7XG59Il19