"use strict";
var util = require('util');
var ATLHelpers = require('./ATLHelpers');
var _ = require('lodash');
var RAML = require('raml-1-parser');
var path = require('path');
if (typeof Promise != 'function')
    require('es6-promise').polyfill();
var ATL = (function () {
    function ATL() {
        this.options = {
            variables: {},
            path: null,
            file: null,
            selfSignedCert: false,
            raml: {
                coverage: true,
                resourceTypes: true,
                traits: true
            }
        };
        this.suites = {};
        this.schemas = {};
    }
    ATL.prototype.fromObject = function (object) {
        var _this = this;
        if (typeof object !== "object")
            throw new TypeError("fromObject: the first parameter must be an object");
        // merge the variables
        if ('variables' in object) {
            if (typeof object.variables != "object")
                throw new TypeError("fromObject.variables: MUST be an object");
            this.options.variables = _.merge(this.options.variables || {}, object.variables);
        }
        else {
            this.options.variables = this.options.variables || {};
        }
        // override variables.ENV if not exists or is an object
        if (!this.options.variables['ENV'] || typeof this.options.variables['ENV'] != "object")
            this.options.variables['ENV'] = {};
        _.extend(this.options.variables['ENV'], _.cloneDeep(process.env));
        // prepare the baseUri
        if ('baseUri' in object) {
            if (typeof object.baseUri == "string")
                this.options.baseUri = object.baseUri;
            else
                throw new TypeError("baseUri: invalid type");
            if (this.options.baseUri.substr(-1) === '/') {
                this.options.baseUri = this.options.baseUri.substr(0, this.options.baseUri.length - 1);
            }
        }
        if ('options' in object) {
            ATLHelpers.ensureInstanceOf("options", object.options, Object);
            Object.keys(object.options).forEach(function (key) {
                var value = object.options[key];
                switch (key) {
                    case 'selfSignedCert':
                        ATLHelpers.ensureInstanceOf("options.selfSignedCert", value, Boolean);
                        _this.options.selfSignedCert = !!value;
                        break;
                    case 'raml':
                        ATLHelpers.ensureInstanceOf("options.raml", value, Object);
                        _.merge(_this.options.raml, value);
                        break;
                    default:
                        throw new TypeError("unknown option:" + key);
                }
            });
        }
        if ('baseUriParameters' in object) {
            if (!object.baseUriParameters || typeof object.baseUriParameters != "object" || object.baseUriParameters instanceof Array)
                throw new TypeError("baseUriParameters: MUST be a dictionary");
            this.options.baseUriParameters = _.cloneDeep(object.baseUriParameters);
        }
        // parse the tests
        if ('tests' in object) {
            if (!object.tests || typeof object.tests != "object" || object.tests instanceof Array) {
                throw new TypeError("tests: MUST be a dictionary");
            }
            var suite_1 = null;
            for (var sequenceName in object.tests) {
                suite_1 = ATLHelpers.parseSuites(object.tests[sequenceName], this);
                suite_1.name = sequenceName;
                this.suites[suite_1.name] = suite_1;
            }
        }
        if ('schemas' in object) {
            if (!object.schemas || !(object.schemas instanceof Array)) {
                throw new TypeError("schemas: MUST be a list");
            }
            for (var sequenceName in object.schemas) {
                var schemaName = null;
                if (typeof object.schemas[sequenceName] == "string") {
                    // load string schema by path
                    // TODO, load schema
                    this._addSchema(sequenceName, {});
                }
                else if (typeof object.schemas[sequenceName] == "object") {
                    this._addSchema(schemaName, object.schemas[sequenceName]);
                }
                else {
                    throw new TypeError("schemas: invalid schema " + sequenceName);
                }
            }
        }
        if ('raml' in object) {
            if (!object.raml || typeof object.raml != "string") {
                throw new TypeError("raml: MUST be a string");
            }
            try {
                this.raml = RAML.loadApiSync(object.raml, { rejectOnErrors: true });
            }
            catch (e) {
                if (e.parserErrors) {
                    throw path.resolve(object.raml) + ':\n' + e.message + "\n" + e.parserErrors.map(function (x) { return "  " + x.message + " line " + x.line; }).join("\n");
                }
                else {
                    console.log(util.inspect(e));
                }
                throw e;
            }
            var schemas = this.raml.schemas();
            for (var i in schemas) {
                var schemaList = schemas[i].toJSON();
                for (var schemaName in schemaList) {
                    var json = null;
                    try {
                        json = JSON.parse(schemaList[schemaName]);
                        this._addSchema(schemaName, json);
                    }
                    catch (e) {
                        e.message = 'Error parsing JSON schema ' + schemaName + '\n\t' + e.message + '\n' + util.inspect(schemaList[schemaName]);
                        throw e;
                    }
                }
            }
        }
        for (var suiteKey in this.suites) {
            this.replaceSchema(this.suites[suiteKey]);
        }
    };
    ATL.prototype.replaceSchema = function (suite) {
        if (suite.test && suite.test.response.body && suite.test.response.body.schema) {
            if (typeof suite.test.response.body.schema == "string") {
                if (suite.test.response.body.schema in this.schemas) {
                    suite.test.response.body.schema = this.schemas[suite.test.response.body.schema];
                }
                else {
                    throw new Error('schema ' + suite.test.response.body.schema + ' not found on test ' + suite.test.method + ' ' + suite.test.uri);
                }
            }
        }
        if (suite.suites) {
            for (var suiteKey in suite.suites) {
                this.replaceSchema(suite.suites[suiteKey]);
            }
        }
    };
    ATL.prototype._addSchema = function (schemaName, schema) {
        if (schemaName in this.schemas)
            throw new TypeError("schemas: duplicated schema " + schemaName);
        // VALIDATE SCHEMA
        this.schemas[schemaName] = schema;
    };
    return ATL;
}());
exports.ATL = ATL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQVRMLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQVRMLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUU5QixJQUFPLFVBQVUsV0FBVyxjQUFjLENBQUMsQ0FBQztBQUM1QyxJQUFPLENBQUMsV0FBVyxRQUFRLENBQUMsQ0FBQztBQUM3QixJQUFPLElBQUksV0FBVyxlQUFlLENBQUMsQ0FBQztBQUl2QyxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUU5QixFQUFFLENBQUMsQ0FBQyxPQUFPLE9BQU8sSUFBSSxVQUFVLENBQUM7SUFDL0IsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBZ0JwQztJQUFBO1FBQ0UsWUFBTyxHQUFnQjtZQUNyQixTQUFTLEVBQUUsRUFBRTtZQUNiLElBQUksRUFBRSxJQUFJO1lBQ1YsSUFBSSxFQUFFLElBQUk7WUFDVixjQUFjLEVBQUUsS0FBSztZQUNyQixJQUFJLEVBQUU7Z0JBQ0osUUFBUSxFQUFFLElBQUk7Z0JBQ2QsYUFBYSxFQUFFLElBQUk7Z0JBQ25CLE1BQU0sRUFBRSxJQUFJO2FBQ2I7U0FDRixDQUFDO1FBTUYsV0FBTSxHQUFnRCxFQUFFLENBQUM7UUFFekQsWUFBTyxHQUFnQyxFQUFFLENBQUM7SUFvSzVDLENBQUM7SUFsS0Msd0JBQVUsR0FBVixVQUFXLE1BQVc7UUFBdEIsaUJBc0lDO1FBcklDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sTUFBTSxLQUFLLFFBQVEsQ0FBQztZQUM3QixNQUFNLElBQUksU0FBUyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7UUFFM0Usc0JBQXNCO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzFCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sTUFBTSxDQUFDLFNBQVMsSUFBSSxRQUFRLENBQUM7Z0JBQ3RDLE1BQU0sSUFBSSxTQUFT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blxuaW1wb3J0IEFUTEhlbHBlcnMgPSByZXF1aXJlKCcuL0FUTEhlbHBlcnMnKTtcbmltcG9ydCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5pbXBvcnQgUkFNTCA9IHJlcXVpcmUoJ3JhbWwtMS1wYXJzZXInKTtcblxuaW1wb3J0IHsgU3VwZXJBZ2VudCwgU3VwZXJBZ2VudFJlcXVlc3QsIGFnZW50IH0gZnJvbSAnc3VwZXJhZ2VudCc7XG5cbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5pZiAodHlwZW9mIFByb21pc2UgIT0gJ2Z1bmN0aW9uJylcbiAgcmVxdWlyZSgnZXM2LXByb21pc2UnKS5wb2x5ZmlsbCgpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElBVExPcHRpb25zIHtcbiAgdmFyaWFibGVzPzogQVRMSGVscGVycy5JRGljdGlvbmFyeTxhbnk+O1xuICBwYXRoPzogc3RyaW5nO1xuICBmaWxlPzogc3RyaW5nO1xuICBiYXNlVXJpPzogc3RyaW5nO1xuICBiYXNlVXJpUGFyYW1ldGVycz86IEFUTEhlbHBlcnMuSURpY3Rpb25hcnk8c3RyaW5nPjtcbiAgc2VsZlNpZ25lZENlcnQ6IGJvb2xlYW47XG4gIHJhbWw6IHtcbiAgICBjb3ZlcmFnZTogYm9vbGVhbjtcbiAgICByZXNvdXJjZVR5cGVzOiBib29sZWFuO1xuICAgIHRyYWl0czogYm9vbGVhbjtcbiAgfTtcbn1cblxuZXhwb3J0IGNsYXNzIEFUTCB7XG4gIG9wdGlvbnM6IElBVExPcHRpb25zID0ge1xuICAgIHZhcmlhYmxlczoge30sXG4gICAgcGF0aDogbnVsbCxcbiAgICBmaWxlOiBudWxsLFxuICAgIHNlbGZTaWduZWRDZXJ0OiBmYWxzZSxcbiAgICByYW1sOiB7XG4gICAgICBjb3ZlcmFnZTogdHJ1ZSxcbiAgICAgIHJlc291cmNlVHlwZXM6IHRydWUsXG4gICAgICB0cmFpdHM6IHRydWVcbiAgICB9XG4gIH07XG5cbiAgYWdlbnQ6IFN1cGVyQWdlbnQ8U3VwZXJBZ2VudFJlcXVlc3Q+O1xuXG4gIHJhbWw6IFJBTUwuYXBpMDguQXBpIHwgUkFNTC5hcGkxMC5BcGk7XG5cbiAgc3VpdGVzOiBBVExIZWxwZXJzLklEaWN0aW9uYXJ5PEFUTEhlbHBlcnMuQVRMU3VpdGU+ID0ge307XG5cbiAgc2NoZW1hczogQVRMSGVscGVycy5JRGljdGlvbmFyeTxhbnk+ID0ge307XG5cbiAgZnJvbU9iamVjdChvYmplY3Q6IGFueSkge1xuICAgIGlmICh0eXBlb2Ygb2JqZWN0ICE9PSBcIm9iamVjdFwiKVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImZyb21PYmplY3Q6IHRoZSBmaXJzdCBwYXJhbWV0ZXIgbXVzdCBiZSBhbiBvYmplY3RcIik7XG5cbiAgICAvLyBtZXJnZSB0aGUgdmFyaWFibGVzXG4gICAgaWYgKCd2YXJpYWJsZXMnIGluIG9iamVjdCkge1xuICAgICAgaWYgKHR5cGVvZiBvYmplY3QudmFyaWFibGVzICE9IFwib2JqZWN0XCIpXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJmcm9tT2JqZWN0LnZhcmlhYmxlczogTVVTVCBiZSBhbiBvYmplY3RcIik7XG5cbiAgICAgIHRoaXMub3B0aW9ucy52YXJpYWJsZXMgPSBfLm1lcmdlKHRoaXMub3B0aW9ucy52YXJpYWJsZXMgfHwge30sIG9iamVjdC52YXJpYWJsZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wdGlvbnMudmFyaWFibGVzID0gdGhpcy5vcHRpb25zLnZhcmlhYmxlcyB8fCB7fTtcbiAgICB9XG5cbiAgICAvLyBvdmVycmlkZSB2YXJpYWJsZXMuRU5WIGlmIG5vdCBleGlzdHMgb3IgaXMgYW4gb2JqZWN0XG5cbiAgICBpZiAoIXRoaXMub3B0aW9ucy52YXJpYWJsZXNbJ0VOViddIHx8IHR5cGVvZiB0aGlzLm9wdGlvbnMudmFyaWFibGVzWydFTlYnXSAhPSBcIm9iamVjdFwiKVxuICAgICAgdGhpcy5vcHRpb25zLnZhcmlhYmxlc1snRU5WJ10gPSB7fTtcblxuICAgIF8uZXh0ZW5kKHRoaXMub3B0aW9ucy52YXJpYWJsZXNbJ0VOViddLCBfLmNsb25lRGVlcChwcm9jZXNzLmVudikpO1xuXG4gICAgLy8gcHJlcGFyZSB0aGUgYmFzZVVyaVxuICAgIGlmICgnYmFzZVVyaScgaW4gb2JqZWN0KSB7XG4gICAgICBpZiAodHlwZW9mIG9iamVjdC5iYXNlVXJpID09IFwic3RyaW5nXCIpXG4gICAgICAgIHRoaXMub3B0aW9ucy5iYXNlVXJpID0gb2JqZWN0LmJhc2VVcmk7XG4gICAgICBlbHNlXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJiYXNlVXJpOiBpbnZhbGlkIHR5cGVcIik7XG5cbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuYmFzZVVyaS5zdWJzdHIoLTEpID09PSAnLycpIHtcbiAgICAgICAgdGhpcy5vcHRpb25zLmJhc2VVcmkgPSB0aGlzLm9wdGlvbnMuYmFzZVVyaS5zdWJzdHIoMCwgdGhpcy5vcHRpb25zLmJhc2VVcmkubGVuZ3RoIC0gMSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCdvcHRpb25zJyBpbiBvYmplY3QpIHtcbiAgICAgIEFUTEhlbHBlcnMuZW5zdXJlSW5zdGFuY2VPZihcIm9wdGlvbnNcIiwgb2JqZWN0Lm9wdGlvbnMsIE9iamVjdCk7XG5cbiAgICAgIE9iamVjdC5rZXlzKG9iamVjdC5vcHRpb25zKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGxldCB2YWx1ZSA9IG9iamVjdC5vcHRpb25zW2tleV07XG5cbiAgICAgICAgc3dpdGNoIChrZXkpIHtcbiAgICAgICAgICBjYXNlICdzZWxmU2lnbmVkQ2VydCc6XG4gICAgICAgICAgICBBVExIZWxwZXJzLmVuc3VyZUluc3RhbmNlT2YoXCJvcHRpb25zLnNlbGZTaWduZWRDZXJ0XCIsIHZhbHVlLCBCb29sZWFuKTtcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zZWxmU2lnbmVkQ2VydCA9ICEhdmFsdWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdyYW1sJzpcbiAgICAgICAgICAgIEFUTEhlbHBlcnMuZW5zdXJlSW5zdGFuY2VPZihcIm9wdGlvbnMucmFtbFwiLCB2YWx1ZSwgT2JqZWN0KTtcbiAgICAgICAgICAgIF8ubWVyZ2UodGhpcy5vcHRpb25zLnJhbWwsIHZhbHVlKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwidW5rbm93biBvcHRpb246XCIgKyBrZXkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoJ2Jhc2VVcmlQYXJhbWV0ZXJzJyBpbiBvYmplY3QpIHtcbiAgICAgIGlmICghb2JqZWN0LmJhc2VVcmlQYXJhbWV0ZXJzIHx8IHR5cGVvZiBvYmplY3QuYmFzZVVyaVBhcmFtZXRlcnMgIT0gXCJvYmplY3RcIiB8fCBvYmplY3QuYmFzZVVyaVBhcmFtZXRlcnMgaW5zdGFuY2VvZiBBcnJheSlcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImJhc2VVcmlQYXJhbWV0ZXJzOiBNVVNUIGJlIGEgZGljdGlvbmFyeVwiKTtcblxuICAgICAgdGhpcy5vcHRpb25zLmJhc2VVcmlQYXJhbWV0ZXJzID0gXy5jbG9uZURlZXAob2JqZWN0LmJhc2VVcmlQYXJhbWV0ZXJzKTtcbiAgICB9XG5cbiAgICAvLyBwYXJzZSB0aGUgdGVzdHNcbiAgICBpZiAoJ3Rlc3RzJyBpbiBvYmplY3QpIHtcbiAgICAgIGlmICghb2JqZWN0LnRlc3RzIHx8IHR5cGVvZiBvYmplY3QudGVzdHMgIT0gXCJvYmplY3RcIiB8fCBvYmplY3QudGVzdHMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwidGVzdHM6IE1VU1QgYmUgYSBkaWN0aW9uYXJ5XCIpO1xuICAgICAgfVxuXG4gICAgICBsZXQgc3VpdGU6IEFUTEhlbHBlcnMuQVRMU3VpdGUgPSBudWxsO1xuXG4gICAgICBmb3IgKGxldCBzZXF1ZW5jZU5hbWUgaW4gb2JqZWN0LnRlc3RzKSB7XG4gICAgICAgIHN1aXRlID0gQVRMSGVscGVycy5wYXJzZVN1aXRlcyhvYmplY3QudGVzdHNbc2VxdWVuY2VOYW1lXSwgdGhpcyk7XG4gICAgICAgIHN1aXRlLm5hbWUgPSBzZXF1ZW5jZU5hbWU7XG5cbiAgICAgICAgdGhpcy5zdWl0ZXNbc3VpdGUubmFtZV0gPSBzdWl0ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoJ3NjaGVtYXMnIGluIG9iamVjdCkge1xuICAgICAgaWYgKCFvYmplY3Quc2NoZW1hcyB8fCAhKG9iamVjdC5zY2hlbWFzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJzY2hlbWFzOiBNVVNUIGJlIGEgbGlzdFwiKTtcbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgc2VxdWVuY2VOYW1lIGluIG9iamVjdC5zY2hlbWFzKSB7XG4gICAgICAgIGxldCBzY2hlbWFOYW1lOiBzdHJpbmcgPSBudWxsO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnNjaGVtYXNbc2VxdWVuY2VOYW1lXSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgLy8gbG9hZCBzdHJpbmcgc2NoZW1hIGJ5IHBhdGhcbiAgICAgICAgICAvLyBUT0RPLCBsb2FkIHNjaGVtYVxuICAgICAgICAgIHRoaXMuX2FkZFNjaGVtYShzZXF1ZW5jZU5hbWUsIHt9KTtcblxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmplY3Quc2NoZW1hc1tzZXF1ZW5jZU5hbWVdID09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICB0aGlzLl9hZGRTY2hlbWEoc2NoZW1hTmFtZSwgb2JqZWN0LnNjaGVtYXNbc2VxdWVuY2VOYW1lXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcInNjaGVtYXM6IGludmFsaWQgc2NoZW1hIFwiICsgc2VxdWVuY2VOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICgncmFtbCcgaW4gb2JqZWN0KSB7XG4gICAgICBpZiAoIW9iamVjdC5yYW1sIHx8IHR5cGVvZiBvYmplY3QucmFtbCAhPSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJyYW1sOiBNVVNUIGJlIGEgc3RyaW5nXCIpO1xuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnJhbWwgPSBSQU1MLmxvYWRBcGlTeW5jKG9iamVjdC5yYW1sLCB7IHJlamVjdE9uRXJyb3JzOiB0cnVlIH0pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZS5wYXJzZXJFcnJvcnMpIHtcbiAgICAgICAgICB0aHJvdyBwYXRoLnJlc29sdmUob2JqZWN0LnJhbWwpICsgJzpcXG4nICsgZS5tZXNzYWdlICsgXCJcXG5cIiArIGUucGFyc2VyRXJyb3JzLm1hcCh4ID0+IFwiICBcIiArIHgubWVzc2FnZSArIFwiIGxpbmUgXCIgKyB4LmxpbmUpLmpvaW4oXCJcXG5cIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2codXRpbC5pbnNwZWN0KGUpKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuXG4gICAgICBsZXQgc2NoZW1hcyA9IHRoaXMucmFtbC5zY2hlbWFzKCk7XG5cbiAgICAgIGZvciAobGV0IGkgaW4gc2NoZW1hcykge1xuICAgICAgICBsZXQgc2NoZW1hTGlzdCA9IHNjaGVtYXNbaV0udG9KU09OKCk7XG4gICAgICAgIGZvciAobGV0IHNjaGVtYU5hbWUgaW4gc2NoZW1hTGlzdCkge1xuICAgICAgICAgIGxldCBqc29uID0gbnVsbDtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAganNvbiA9IEpTT04ucGFyc2Uoc2NoZW1hTGlzdFtzY2hlbWFOYW1lXSk7XG4gICAgICAgICAgICB0aGlzLl9hZGRTY2hlbWEoc2NoZW1hTmFtZSwganNvbik7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgZS5tZXNzYWdlID0gJ0Vycm9yIHBhcnNpbmcgSlNPTiBzY2hlbWEgJyArIHNjaGVtYU5hbWUgKyAnXFxuXFx0JyArIGUubWVzc2FnZSArICdcXG4nICsgdXRpbC5pbnNwZWN0KHNjaGVtYUxpc3Rbc2NoZW1hTmFtZV0pO1xuICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGxldCBzdWl0ZUtleSBpbiB0aGlzLnN1aXRlcykge1xuICAgICAgdGhpcy5yZXBsYWNlU2NoZW1hKHRoaXMuc3VpdGVzW3N1aXRlS2V5XSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXBsYWNlU2NoZW1hKHN1aXRlOiBBVExIZWxwZXJzLkFUTFN1aXRlKSB7XG4gICAgaWYgKHN1aXRlLnRlc3QgJiYgc3VpdGUudGVzdC5yZXNwb25zZS5ib2R5ICYmIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWEpIHtcbiAgICAgIGlmICh0eXBlb2Ygc3VpdGUudGVzdC5yZXNwb25zZS5ib2R5LnNjaGVtYSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGlmIChzdWl0ZS50ZXN0LnJlc3BvbnNlLmJvZHkuc2NoZW1hIGluIHRoaXMuc2NoZW1hcykge1xuICAgICAgICAgIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWEgPSB0aGlzLnNjaGVtYXNbc3VpdGUudGVzdC5yZXNwb25zZS5ib2R5LnNjaGVtYV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzY2hlbWEgJyArIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWEgKyAnIG5vdCBmb3VuZCBvbiB0ZXN0ICcgKyBzdWl0ZS50ZXN0Lm1ldGhvZCArICcgJyArIHN1aXRlLnRlc3QudXJpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzdWl0ZS5zdWl0ZXMpIHtcbiAgICAgIGZvciAobGV0IHN1aXRlS2V5IGluIHN1aXRlLnN1aXRlcykge1xuICAgICAgICB0aGlzLnJlcGxhY2VTY2hlbWEoc3VpdGUuc3VpdGVzW3N1aXRlS2V5XSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfYWRkU2NoZW1hKHNjaGVtYU5hbWU6IHN0cmluZywgc2NoZW1hOiBhbnkpIHtcbiAgICBpZiAoc2NoZW1hTmFtZSBpbiB0aGlzLnNjaGVtYXMpXG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwic2NoZW1hczogZHVwbGljYXRlZCBzY2hlbWEgXCIgKyBzY2hlbWFOYW1lKTtcblxuICAgIC8vIFZBTElEQVRFIFNDSEVNQVxuXG4gICAgdGhpcy5zY2hlbWFzW3NjaGVtYU5hbWVdID0gc2NoZW1hO1xuICB9XG59Il19