"use strict";
var util = require('util');
var ATLHelpers = require('./ATLHelpers');
var _ = require('lodash');
var RAML = require('raml-1-parser');
var jsonschema = require('jsonschema');
var path = require('path');
if (typeof Promise != 'function')
    require('es6-promise').polyfill();
var ATL = (function () {
    function ATL() {
        this.options = {
            variables: {},
            path: null,
            file: null,
            selfSignedCert: false,
            raml: {
                coverage: true,
                resourceTypes: true,
                traits: true
            }
        };
        this.suites = {};
        this.schemas = {};
    }
    ATL.prototype.fromObject = function (object) {
        var _this = this;
        if (typeof object !== "object")
            throw new TypeError("fromObject: the first parameter must be an object");
        // merge the variables
        if ('variables' in object) {
            if (typeof object.variables != "object")
                throw new TypeError("fromObject.variables: MUST be an object");
            this.options.variables = _.merge(this.options.variables || {}, object.variables);
        }
        else {
            this.options.variables = this.options.variables || {};
        }
        // override variables.ENV if not exists or is an object
        if (!this.options.variables['ENV'] || typeof this.options.variables['ENV'] != "object")
            this.options.variables['ENV'] = {};
        _.extend(this.options.variables['ENV'], _.cloneDeep(process.env));
        // prepare the baseUri
        if ('baseUri' in object) {
            if (typeof object.baseUri == "string")
                this.options.baseUri = object.baseUri;
            else
                throw new TypeError("baseUri: invalid type");
            if (this.options.baseUri.substr(-1) === '/') {
                this.options.baseUri = this.options.baseUri.substr(0, this.options.baseUri.length - 1);
            }
        }
        if ('options' in object) {
            ATLHelpers.ensureInstanceOf("options", object.options, Object);
            Object.keys(object.options).forEach(function (key) {
                var value = object.options[key];
                switch (key) {
                    case 'selfSignedCert':
                        ATLHelpers.ensureInstanceOf("options.selfSignedCert", value, Boolean);
                        _this.options.selfSignedCert = !!value;
                        break;
                    case 'raml':
                        ATLHelpers.ensureInstanceOf("options.raml", value, Object);
                        _.merge(_this.options.raml, value);
                        break;
                    default:
                        throw new TypeError("unknown option:" + key);
                }
            });
        }
        if ('baseUriParameters' in object) {
            if (!object.baseUriParameters || typeof object.baseUriParameters != "object" || object.baseUriParameters instanceof Array)
                throw new TypeError("baseUriParameters: MUST be a dictionary");
            this.options.baseUriParameters = _.cloneDeep(object.baseUriParameters);
        }
        // parse the tests
        if ('tests' in object) {
            if (!object.tests || typeof object.tests != "object" || object.tests instanceof Array) {
                throw new TypeError("tests: MUST be a dictionary");
            }
            var suite_1 = null;
            for (var sequenceName in object.tests) {
                suite_1 = ATLHelpers.parseSuites(object.tests[sequenceName], this);
                suite_1.name = sequenceName;
                this.suites[suite_1.name] = suite_1;
            }
        }
        if ('schemas' in object) {
            if (!object.schemas || !(object.schemas instanceof Array)) {
                throw new TypeError("schemas: MUST be a list");
            }
            for (var sequenceName in object.schemas) {
                var schemaName = null;
                if (typeof object.schemas[sequenceName] == "string") {
                    // load string schema by path
                    // TODO, load schema
                    this._addSchema(sequenceName, {});
                }
                else if (typeof object.schemas[sequenceName] == "object") {
                    this._addSchema(schemaName, object.schemas[sequenceName]);
                }
                else {
                    throw new TypeError("schemas: invalid schema " + sequenceName);
                }
            }
        }
        if ('raml' in object) {
            if (!object.raml || typeof object.raml != "string") {
                throw new TypeError("raml: MUST be a string");
            }
            try {
                this.raml = RAML.loadApiSync(object.raml, { rejectOnErrors: true });
            }
            catch (e) {
                if (e.parserErrors) {
                    throw path.resolve(object.raml) + ':\n' + e.message + "\n" + e.parserErrors.map(function (x) { return "  " + x.message + " line " + x.line; }).join("\n");
                }
                else {
                    console.log(util.inspect(e));
                }
                throw e;
            }
            var schemas = this.raml.schemas();
            for (var i in schemas) {
                var schemaList = schemas[i].toJSON();
                for (var schemaName in schemaList) {
                    var json = null;
                    try {
                        json = JSON.parse(schemaList[schemaName]);
                        this._addSchema(schemaName, json);
                    }
                    catch (e) {
                        e.message = 'Error parsing JSON schema ' + schemaName + '\n\t' + e.message + '\n' + util.inspect(schemaList[schemaName]);
                        throw e;
                    }
                }
            }
        }
        for (var suiteKey in this.suites) {
            this.replaceSchema(this.suites[suiteKey]);
        }
    };
    ATL.prototype.obtainSchemaValidator = function (schema) {
        var v = new jsonschema.Validator();
        if (typeof schema == "string") {
            if (schema in this.schemas) {
                v.addSchema(this.schemas[schema], schema);
                schema = this.schemas[schema];
            }
            else {
                try {
                    schema = JSON.parse(schema);
                    v.addSchema(schema);
                }
                catch (e) {
                }
            }
        }
        else if (typeof schema == "object") {
            v.addSchema(schema);
        }
        else {
            throw new Error('Invalid schema ' + util.inspect(schema));
        }
        if (v.unresolvedRefs && v.unresolvedRefs.length) {
            while (v.unresolvedRefs && v.unresolvedRefs.length) {
                var nextSchema = v.unresolvedRefs.shift();
                var theSchema = this.schemas[nextSchema];
                if (!theSchema)
                    throw new Error("schema " + nextSchema + " not found");
                v.addSchema(theSchema, nextSchema);
            }
        }
        return function (content) {
            return v.validate(content, schema);
        };
    };
    ATL.prototype.replaceSchema = function (suite) {
        if (suite.test && suite.test.response.body && suite.test.response.body.schema) {
            if (typeof suite.test.response.body.schema == "string") {
                if (suite.test.response.body.schema in this.schemas) {
                    suite.test.response.body.schema = this.schemas[suite.test.response.body.schema];
                }
                else {
                    throw new Error('schema ' + suite.test.response.body.schema + ' not found on test ' + suite.test.method + ' ' + suite.test.uri);
                }
            }
        }
        if (suite.suites) {
            for (var suiteKey in suite.suites) {
                this.replaceSchema(suite.suites[suiteKey]);
            }
        }
    };
    ATL.prototype._addSchema = function (schemaName, schema) {
        if (schemaName in this.schemas)
            throw new TypeError("schemas: duplicated schema " + schemaName);
        // VALIDATE SCHEMA
        this.schemas[schemaName] = schema;
    };
    return ATL;
}());
exports.ATL = ATL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQVRMLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQVRMLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUU5QixJQUFPLFVBQVUsV0FBVyxjQUFjLENBQUMsQ0FBQztBQUM1QyxJQUFPLENBQUMsV0FBVyxRQUFRLENBQUMsQ0FBQztBQUM3QixJQUFPLElBQUksV0FBVyxlQUFlLENBQUMsQ0FBQztBQUN2QyxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFHekMsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFFOUIsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLElBQUksVUFBVSxDQUFDO0lBQy9CLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQWdCcEM7SUFBQTtRQUNFLFlBQU8sR0FBZ0I7WUFDckIsU0FBUyxFQUFFLEVBQUU7WUFDYixJQUFJLEVBQUUsSUFBSTtZQUNWLElBQUksRUFBRSxJQUFJO1lBQ1YsY0FBYyxFQUFFLEtBQUs7WUFDckIsSUFBSSxFQUFFO2dCQUNKLFFBQVEsRUFBRSxJQUFJO2dCQUNkLGFBQWEsRUFBRSxJQUFJO2dCQUNuQixNQUFNLEVBQUUsSUFBSTthQUNiO1NBQ0YsQ0FBQztRQU1GLFdBQU0sR0FBZ0QsRUFBRSxDQUFDO1FBRXpELFlBQU8sR0FBZ0MsRUFBRSxDQUFDO0lBMk01QyxDQUFDO0lBek1DLHdCQUFVLEdBQVYsVUFBVyxNQUFXO1FBQXRCLGlCQXNJQztRQXJJQyxFQUFFLENBQUMsQ0FBQyxPQUFPLE1BQU0sS0FBSyxRQUFRLENBQUM7WUFDN0IsTUFBTSxJQUFJLFNBQVMsQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO1FBRTNFLHNCQUFzQjtRQUN0QixFQUFFLENBQUMsQ0FBQyxXQUFXLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMxQixFQUFFLENBQUMsQ0FBQyxPQUFPLE1BQU0s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SSxRQUFRLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQzdDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVPLHdCQUFVLEdBQWxCLFVBQW1CLFVBQWtCLEVBQUUsTUFBVztRQUNoRCxFQUFFLENBQUMsQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUM3QixNQUFNLElBQUksU0FBUyxDQUFDLDZCQUE2QixHQUFHLFVBQVUsQ0FBQyxDQUFDO1FBRWxFLGtCQUFrQjtRQUVsQixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU0sQ0FBQztJQUNwQyxDQUFDO0lBQ0gsVUFBQztBQUFELENBQUMsQUE5TkQsSUE4TkM7QUE5TlksV0FBRyxNQThOZixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5cbmltcG9ydCBBVExIZWxwZXJzID0gcmVxdWlyZSgnLi9BVExIZWxwZXJzJyk7XG5pbXBvcnQgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuaW1wb3J0IFJBTUwgPSByZXF1aXJlKCdyYW1sLTEtcGFyc2VyJyk7XG5jb25zdCBqc29uc2NoZW1hID0gcmVxdWlyZSgnanNvbnNjaGVtYScpO1xuaW1wb3J0IHsgU3VwZXJBZ2VudCwgU3VwZXJBZ2VudFJlcXVlc3QsIGFnZW50IH0gZnJvbSAnc3VwZXJhZ2VudCc7XG5cbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5pZiAodHlwZW9mIFByb21pc2UgIT0gJ2Z1bmN0aW9uJylcbiAgcmVxdWlyZSgnZXM2LXByb21pc2UnKS5wb2x5ZmlsbCgpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElBVExPcHRpb25zIHtcbiAgdmFyaWFibGVzPzogQVRMSGVscGVycy5JRGljdGlvbmFyeTxhbnk+O1xuICBwYXRoPzogc3RyaW5nO1xuICBmaWxlPzogc3RyaW5nO1xuICBiYXNlVXJpPzogc3RyaW5nO1xuICBiYXNlVXJpUGFyYW1ldGVycz86IEFUTEhlbHBlcnMuSURpY3Rpb25hcnk8c3RyaW5nPjtcbiAgc2VsZlNpZ25lZENlcnQ6IGJvb2xlYW47XG4gIHJhbWw6IHtcbiAgICBjb3ZlcmFnZTogYm9vbGVhbjtcbiAgICByZXNvdXJjZVR5cGVzOiBib29sZWFuO1xuICAgIHRyYWl0czogYm9vbGVhbjtcbiAgfTtcbn1cblxuZXhwb3J0IGNsYXNzIEFUTCB7XG4gIG9wdGlvbnM6IElBVExPcHRpb25zID0ge1xuICAgIHZhcmlhYmxlczoge30sXG4gICAgcGF0aDogbnVsbCxcbiAgICBmaWxlOiBudWxsLFxuICAgIHNlbGZTaWduZWRDZXJ0OiBmYWxzZSxcbiAgICByYW1sOiB7XG4gICAgICBjb3ZlcmFnZTogdHJ1ZSxcbiAgICAgIHJlc291cmNlVHlwZXM6IHRydWUsXG4gICAgICB0cmFpdHM6IHRydWVcbiAgICB9XG4gIH07XG5cbiAgYWdlbnQ6IFN1cGVyQWdlbnQ8U3VwZXJBZ2VudFJlcXVlc3Q+O1xuXG4gIHJhbWw6IFJBTUwuYXBpMDguQXBpIHwgUkFNTC5hcGkxMC5BcGk7XG5cbiAgc3VpdGVzOiBBVExIZWxwZXJzLklEaWN0aW9uYXJ5PEFUTEhlbHBlcnMuQVRMU3VpdGU+ID0ge307XG5cbiAgc2NoZW1hczogQVRMSGVscGVycy5JRGljdGlvbmFyeTxhbnk+ID0ge307XG5cbiAgZnJvbU9iamVjdChvYmplY3Q6IGFueSkge1xuICAgIGlmICh0eXBlb2Ygb2JqZWN0ICE9PSBcIm9iamVjdFwiKVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImZyb21PYmplY3Q6IHRoZSBmaXJzdCBwYXJhbWV0ZXIgbXVzdCBiZSBhbiBvYmplY3RcIik7XG5cbiAgICAvLyBtZXJnZSB0aGUgdmFyaWFibGVzXG4gICAgaWYgKCd2YXJpYWJsZXMnIGluIG9iamVjdCkge1xuICAgICAgaWYgKHR5cGVvZiBvYmplY3QudmFyaWFibGVzICE9IFwib2JqZWN0XCIpXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJmcm9tT2JqZWN0LnZhcmlhYmxlczogTVVTVCBiZSBhbiBvYmplY3RcIik7XG5cbiAgICAgIHRoaXMub3B0aW9ucy52YXJpYWJsZXMgPSBfLm1lcmdlKHRoaXMub3B0aW9ucy52YXJpYWJsZXMgfHwge30sIG9iamVjdC52YXJpYWJsZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wdGlvbnMudmFyaWFibGVzID0gdGhpcy5vcHRpb25zLnZhcmlhYmxlcyB8fCB7fTtcbiAgICB9XG5cbiAgICAvLyBvdmVycmlkZSB2YXJpYWJsZXMuRU5WIGlmIG5vdCBleGlzdHMgb3IgaXMgYW4gb2JqZWN0XG5cbiAgICBpZiAoIXRoaXMub3B0aW9ucy52YXJpYWJsZXNbJ0VOViddIHx8IHR5cGVvZiB0aGlzLm9wdGlvbnMudmFyaWFibGVzWydFTlYnXSAhPSBcIm9iamVjdFwiKVxuICAgICAgdGhpcy5vcHRpb25zLnZhcmlhYmxlc1snRU5WJ10gPSB7fTtcblxuICAgIF8uZXh0ZW5kKHRoaXMub3B0aW9ucy52YXJpYWJsZXNbJ0VOViddLCBfLmNsb25lRGVlcChwcm9jZXNzLmVudikpO1xuXG4gICAgLy8gcHJlcGFyZSB0aGUgYmFzZVVyaVxuICAgIGlmICgnYmFzZVVyaScgaW4gb2JqZWN0KSB7XG4gICAgICBpZiAodHlwZW9mIG9iamVjdC5iYXNlVXJpID09IFwic3RyaW5nXCIpXG4gICAgICAgIHRoaXMub3B0aW9ucy5iYXNlVXJpID0gb2JqZWN0LmJhc2VVcmk7XG4gICAgICBlbHNlXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJiYXNlVXJpOiBpbnZhbGlkIHR5cGVcIik7XG5cbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuYmFzZVVyaS5zdWJzdHIoLTEpID09PSAnLycpIHtcbiAgICAgICAgdGhpcy5vcHRpb25zLmJhc2VVcmkgPSB0aGlzLm9wdGlvbnMuYmFzZVVyaS5zdWJzdHIoMCwgdGhpcy5vcHRpb25zLmJhc2VVcmkubGVuZ3RoIC0gMSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCdvcHRpb25zJyBpbiBvYmplY3QpIHtcbiAgICAgIEFUTEhlbHBlcnMuZW5zdXJlSW5zdGFuY2VPZihcIm9wdGlvbnNcIiwgb2JqZWN0Lm9wdGlvbnMsIE9iamVjdCk7XG5cbiAgICAgIE9iamVjdC5rZXlzKG9iamVjdC5vcHRpb25zKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGxldCB2YWx1ZSA9IG9iamVjdC5vcHRpb25zW2tleV07XG5cbiAgICAgICAgc3dpdGNoIChrZXkpIHtcbiAgICAgICAgICBjYXNlICdzZWxmU2lnbmVkQ2VydCc6XG4gICAgICAgICAgICBBVExIZWxwZXJzLmVuc3VyZUluc3RhbmNlT2YoXCJvcHRpb25zLnNlbGZTaWduZWRDZXJ0XCIsIHZhbHVlLCBCb29sZWFuKTtcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zZWxmU2lnbmVkQ2VydCA9ICEhdmFsdWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdyYW1sJzpcbiAgICAgICAgICAgIEFUTEhlbHBlcnMuZW5zdXJlSW5zdGFuY2VPZihcIm9wdGlvbnMucmFtbFwiLCB2YWx1ZSwgT2JqZWN0KTtcbiAgICAgICAgICAgIF8ubWVyZ2UodGhpcy5vcHRpb25zLnJhbWwsIHZhbHVlKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwidW5rbm93biBvcHRpb246XCIgKyBrZXkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoJ2Jhc2VVcmlQYXJhbWV0ZXJzJyBpbiBvYmplY3QpIHtcbiAgICAgIGlmICghb2JqZWN0LmJhc2VVcmlQYXJhbWV0ZXJzIHx8IHR5cGVvZiBvYmplY3QuYmFzZVVyaVBhcmFtZXRlcnMgIT0gXCJvYmplY3RcIiB8fCBvYmplY3QuYmFzZVVyaVBhcmFtZXRlcnMgaW5zdGFuY2VvZiBBcnJheSlcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImJhc2VVcmlQYXJhbWV0ZXJzOiBNVVNUIGJlIGEgZGljdGlvbmFyeVwiKTtcblxuICAgICAgdGhpcy5vcHRpb25zLmJhc2VVcmlQYXJhbWV0ZXJzID0gXy5jbG9uZURlZXAob2JqZWN0LmJhc2VVcmlQYXJhbWV0ZXJzKTtcbiAgICB9XG5cbiAgICAvLyBwYXJzZSB0aGUgdGVzdHNcbiAgICBpZiAoJ3Rlc3RzJyBpbiBvYmplY3QpIHtcbiAgICAgIGlmICghb2JqZWN0LnRlc3RzIHx8IHR5cGVvZiBvYmplY3QudGVzdHMgIT0gXCJvYmplY3RcIiB8fCBvYmplY3QudGVzdHMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwidGVzdHM6IE1VU1QgYmUgYSBkaWN0aW9uYXJ5XCIpO1xuICAgICAgfVxuXG4gICAgICBsZXQgc3VpdGU6IEFUTEhlbHBlcnMuQVRMU3VpdGUgPSBudWxsO1xuXG4gICAgICBmb3IgKGxldCBzZXF1ZW5jZU5hbWUgaW4gb2JqZWN0LnRlc3RzKSB7XG4gICAgICAgIHN1aXRlID0gQVRMSGVscGVycy5wYXJzZVN1aXRlcyhvYmplY3QudGVzdHNbc2VxdWVuY2VOYW1lXSwgdGhpcyk7XG4gICAgICAgIHN1aXRlLm5hbWUgPSBzZXF1ZW5jZU5hbWU7XG5cbiAgICAgICAgdGhpcy5zdWl0ZXNbc3VpdGUubmFtZV0gPSBzdWl0ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoJ3NjaGVtYXMnIGluIG9iamVjdCkge1xuICAgICAgaWYgKCFvYmplY3Quc2NoZW1hcyB8fCAhKG9iamVjdC5zY2hlbWFzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJzY2hlbWFzOiBNVVNUIGJlIGEgbGlzdFwiKTtcbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgc2VxdWVuY2VOYW1lIGluIG9iamVjdC5zY2hlbWFzKSB7XG4gICAgICAgIGxldCBzY2hlbWFOYW1lOiBzdHJpbmcgPSBudWxsO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnNjaGVtYXNbc2VxdWVuY2VOYW1lXSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgLy8gbG9hZCBzdHJpbmcgc2NoZW1hIGJ5IHBhdGhcbiAgICAgICAgICAvLyBUT0RPLCBsb2FkIHNjaGVtYVxuICAgICAgICAgIHRoaXMuX2FkZFNjaGVtYShzZXF1ZW5jZU5hbWUsIHt9KTtcblxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmplY3Quc2NoZW1hc1tzZXF1ZW5jZU5hbWVdID09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICB0aGlzLl9hZGRTY2hlbWEoc2NoZW1hTmFtZSwgb2JqZWN0LnNjaGVtYXNbc2VxdWVuY2VOYW1lXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcInNjaGVtYXM6IGludmFsaWQgc2NoZW1hIFwiICsgc2VxdWVuY2VOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICgncmFtbCcgaW4gb2JqZWN0KSB7XG4gICAgICBpZiAoIW9iamVjdC5yYW1sIHx8IHR5cGVvZiBvYmplY3QucmFtbCAhPSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJyYW1sOiBNVVNUIGJlIGEgc3RyaW5nXCIpO1xuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnJhbWwgPSBSQU1MLmxvYWRBcGlTeW5jKG9iamVjdC5yYW1sLCB7IHJlamVjdE9uRXJyb3JzOiB0cnVlIH0pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZS5wYXJzZXJFcnJvcnMpIHtcbiAgICAgICAgICB0aHJvdyBwYXRoLnJlc29sdmUob2JqZWN0LnJhbWwpICsgJzpcXG4nICsgZS5tZXNzYWdlICsgXCJcXG5cIiArIGUucGFyc2VyRXJyb3JzLm1hcCh4ID0+IFwiICBcIiArIHgubWVzc2FnZSArIFwiIGxpbmUgXCIgKyB4LmxpbmUpLmpvaW4oXCJcXG5cIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2codXRpbC5pbnNwZWN0KGUpKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuXG4gICAgICBsZXQgc2NoZW1hcyA9IHRoaXMucmFtbC5zY2hlbWFzKCk7XG5cbiAgICAgIGZvciAobGV0IGkgaW4gc2NoZW1hcykge1xuICAgICAgICBsZXQgc2NoZW1hTGlzdCA9IHNjaGVtYXNbaV0udG9KU09OKCk7XG4gICAgICAgIGZvciAobGV0IHNjaGVtYU5hbWUgaW4gc2NoZW1hTGlzdCkge1xuICAgICAgICAgIGxldCBqc29uID0gbnVsbDtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAganNvbiA9IEpTT04ucGFyc2Uoc2NoZW1hTGlzdFtzY2hlbWFOYW1lXSk7XG4gICAgICAgICAgICB0aGlzLl9hZGRTY2hlbWEoc2NoZW1hTmFtZSwganNvbik7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgZS5tZXNzYWdlID0gJ0Vycm9yIHBhcnNpbmcgSlNPTiBzY2hlbWEgJyArIHNjaGVtYU5hbWUgKyAnXFxuXFx0JyArIGUubWVzc2FnZSArICdcXG4nICsgdXRpbC5pbnNwZWN0KHNjaGVtYUxpc3Rbc2NoZW1hTmFtZV0pO1xuICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGxldCBzdWl0ZUtleSBpbiB0aGlzLnN1aXRlcykge1xuICAgICAgdGhpcy5yZXBsYWNlU2NoZW1hKHRoaXMuc3VpdGVzW3N1aXRlS2V5XSk7XG4gICAgfVxuICB9XG5cbiAgb2J0YWluU2NoZW1hVmFsaWRhdG9yKHNjaGVtYTogYW55KSB7XG4gICAgbGV0IHYgPSBuZXcganNvbnNjaGVtYS5WYWxpZGF0b3IoKTtcblxuICAgIGlmICh0eXBlb2Ygc2NoZW1hID09IFwic3RyaW5nXCIpIHtcbiAgICAgIGlmIChzY2hlbWEgaW4gdGhpcy5zY2hlbWFzKSB7XG4gICAgICAgIHYuYWRkU2NoZW1hKHRoaXMuc2NoZW1hc1tzY2hlbWFdLCBzY2hlbWEpO1xuICAgICAgICBzY2hlbWEgPSB0aGlzLnNjaGVtYXNbc2NoZW1hXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgc2NoZW1hID0gSlNPTi5wYXJzZShzY2hlbWEpO1xuICAgICAgICAgIHYuYWRkU2NoZW1hKHNjaGVtYSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcblxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygc2NoZW1hID09IFwib2JqZWN0XCIpIHtcbiAgICAgIHYuYWRkU2NoZW1hKHNjaGVtYSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzY2hlbWEgJyArIHV0aWwuaW5zcGVjdChzY2hlbWEpKTtcbiAgICB9XG5cbiAgICBpZiAodi51bnJlc29sdmVkUmVmcyAmJiB2LnVucmVzb2x2ZWRSZWZzLmxlbmd0aCkge1xuICAgICAgd2hpbGUgKHYudW5yZXNvbHZlZFJlZnMgJiYgdi51bnJlc29sdmVkUmVmcy5sZW5ndGgpIHtcbiAgICAgICAgbGV0IG5leHRTY2hlbWEgPSB2LnVucmVzb2x2ZWRSZWZzLnNoaWZ0KCk7XG5cbiAgICAgICAgbGV0IHRoZVNjaGVtYSA9IHRoaXMuc2NoZW1hc1tuZXh0U2NoZW1hXTtcblxuICAgICAgICBpZiAoIXRoZVNjaGVtYSlcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJzY2hlbWEgXCIgKyBuZXh0U2NoZW1hICsgXCIgbm90IGZvdW5kXCIpO1xuXG4gICAgICAgIHYuYWRkU2NoZW1hKHRoZVNjaGVtYSwgbmV4dFNjaGVtYSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIChjb250ZW50KSA6IHsgdmFsaWQ6IGJvb2xlYW47IGVycm9yczogYW55W107IH0gPT4ge1xuICAgICAgcmV0dXJuIHYudmFsaWRhdGUoY29udGVudCwgc2NoZW1hKTtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSByZXBsYWNlU2NoZW1hKHN1aXRlOiBBVExIZWxwZXJzLkFUTFN1aXRlKSB7XG4gICAgaWYgKHN1aXRlLnRlc3QgJiYgc3VpdGUudGVzdC5yZXNwb25zZS5ib2R5ICYmIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWEpIHtcbiAgICAgIGlmICh0eXBlb2Ygc3VpdGUudGVzdC5yZXNwb25zZS5ib2R5LnNjaGVtYSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGlmIChzdWl0ZS50ZXN0LnJlc3BvbnNlLmJvZHkuc2NoZW1hIGluIHRoaXMuc2NoZW1hcykge1xuICAgICAgICAgIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWEgPSB0aGlzLnNjaGVtYXNbc3VpdGUudGVzdC5yZXNwb25zZS5ib2R5LnNjaGVtYV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzY2hlbWEgJyArIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWEgKyAnIG5vdCBmb3VuZCBvbiB0ZXN0ICcgKyBzdWl0ZS50ZXN0Lm1ldGhvZCArICcgJyArIHN1aXRlLnRlc3QudXJpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzdWl0ZS5zdWl0ZXMpIHtcbiAgICAgIGZvciAobGV0IHN1aXRlS2V5IGluIHN1aXRlLnN1aXRlcykge1xuICAgICAgICB0aGlzLnJlcGxhY2VTY2hlbWEoc3VpdGUuc3VpdGVzW3N1aXRlS2V5XSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfYWRkU2NoZW1hKHNjaGVtYU5hbWU6IHN0cmluZywgc2NoZW1hOiBhbnkpIHtcbiAgICBpZiAoc2NoZW1hTmFtZSBpbiB0aGlzLnNjaGVtYXMpXG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwic2NoZW1hczogZHVwbGljYXRlZCBzY2hlbWEgXCIgKyBzY2hlbWFOYW1lKTtcblxuICAgIC8vIFZBTElEQVRFIFNDSEVNQVxuXG4gICAgdGhpcy5zY2hlbWFzW3NjaGVtYU5hbWVdID0gc2NoZW1hO1xuICB9XG59Il19