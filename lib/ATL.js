"use strict";
var util = require('util');
var ATLHelpers = require('./ATLHelpers');
var _ = require('lodash');
var RAML = require('raml-1-parser');
var path = require('path');
if (typeof Promise != 'function')
    require('es6-promise').polyfill();
var ATL = (function () {
    function ATL() {
        this.options = {
            variables: {},
            path: null,
            file: null,
            selfSignedCert: false,
            raml: {
                coverage: true,
                resourceTypes: true,
                traits: true
            }
        };
        this.suites = {};
        this.schemas = {};
    }
    ATL.prototype.fromObject = function (object) {
        var _this = this;
        if (typeof object !== "object")
            throw new TypeError("fromObject: the first parameter must be an object");
        // merge the variables
        if ('variables' in object) {
            if (typeof object.variables != "object")
                throw new TypeError("fromObject.variables: MUST be an object");
            this.options.variables = _.merge(this.options.variables || {}, object.variables);
        }
        else {
            this.options.variables = this.options.variables || {};
        }
        // override variables.ENV if not exists or is an object
        if (!this.options.variables['ENV'] || typeof this.options.variables['ENV'] != "object")
            this.options.variables['ENV'] = {};
        _.extend(this.options.variables['ENV'], _.cloneDeep(process.env));
        // prepare the baseUri
        if ('baseUri' in object) {
            if (typeof object.baseUri == "string")
                this.options.baseUri = object.baseUri;
            else
                throw new TypeError("baseUri: invalid type");
            if (this.options.baseUri.substr(-1) === '/') {
                this.options.baseUri = this.options.baseUri.substr(0, this.options.baseUri.length - 1);
            }
        }
        if ('options' in object) {
            ATLHelpers.ensureInstanceOf("options", object.options, Object);
            Object.keys(object.options).forEach(function (key) {
                var value = object.options[key];
                switch (key) {
                    case 'selfSignedCert':
                        ATLHelpers.ensureInstanceOf("options.selfSignedCert", value, Boolean);
                        _this.options.selfSignedCert = !!value;
                        break;
                    case 'raml':
                        ATLHelpers.ensureInstanceOf("options.raml", value, Object);
                        _.merge(_this.options.raml, value);
                        break;
                    default:
                        throw new TypeError("unknown option:" + key);
                }
            });
        }
        if ('baseUriParameters' in object) {
            if (!object.baseUriParameters || typeof object.baseUriParameters != "object" || object.baseUriParameters instanceof Array)
                throw new TypeError("baseUriParameters: MUST be a dictionary");
            this.options.baseUriParameters = _.cloneDeep(object.baseUriParameters);
        }
        // parse the tests
        if ('tests' in object) {
            if (!object.tests || typeof object.tests != "object" || object.tests instanceof Array) {
                throw new TypeError("tests: MUST be a dictionary");
            }
            var suite_1 = null;
            for (var sequenceName in object.tests) {
                suite_1 = ATLHelpers.parseSuites(object.tests[sequenceName], this);
                suite_1.name = sequenceName;
                this.suites[suite_1.name] = suite_1;
            }
        }
        if ('schemas' in object) {
            if (!object.schemas || !(object.schemas instanceof Array)) {
                throw new TypeError("schemas: MUST be a list");
            }
            for (var sequenceName in object.schemas) {
                var schemaName = null;
                if (typeof object.schemas[sequenceName] == "string") {
                    // load string schema by path
                    // TODO, load schema
                    this._addSchema(sequenceName, {});
                }
                else if (typeof object.schemas[sequenceName] == "object") {
                    this._addSchema(schemaName, object.schemas[sequenceName]);
                }
                else {
                    throw new TypeError("schemas: invalid schema " + sequenceName);
                }
            }
        }
        if ('raml' in object) {
            if (!object.raml || typeof object.raml != "string") {
                throw new TypeError("raml: MUST be a string");
            }
            try {
                this.raml = RAML.loadApiSync(object.raml, { rejectOnErrors: true });
            }
            catch (e) {
                if (e.parserErrors) {
                    throw path.resolve(object.raml) + ':\n' + e.message + "\n" + e.parserErrors.map(function (x) { return "  " + x.message + " line " + x.line; }).join("\n");
                }
                else {
                    console.log(util.inspect(e));
                }
                throw e;
            }
            var schemas = this.raml.schemas();
            for (var i in schemas) {
                var schemaList = schemas[i].toJSON();
                for (var schemaName in schemaList) {
                    var json = null;
                    try {
                        json = JSON.parse(schemaList[schemaName]);
                        this._addSchema(schemaName, json);
                    }
                    catch (e) {
                        e.message = 'Error parsing JSON schema ' + schemaName + '\n\t' + e.message + '\n' + util.inspect(schemaList[schemaName]);
                        throw e;
                    }
                }
            }
        }
        for (var suiteKey in this.suites) {
            this.replaceSchema(this.suites[suiteKey]);
        }
    };
    ATL.prototype.replaceSchema = function (suite) {
        if (suite.test && suite.test.response.body && suite.test.response.body.schema) {
            if (typeof suite.test.response.body.schema == "string") {
                if (suite.test.response.body.schema in this.schemas) {
                    suite.test.response.body.schema = this.schemas[suite.test.response.body.schema];
                }
                else {
                    throw new Error('schema ' + suite.test.response.body.schema + ' not found on test ' + suite.test.method + ' ' + suite.test.uri);
                }
            }
        }
        if (suite.suites) {
            for (var suiteKey in suite.suites) {
                this.replaceSchema(suite.suites[suiteKey]);
            }
        }
    };
    ATL.prototype._addSchema = function (schemaName, schema) {
        if (schemaName in this.schemas)
            throw new TypeError("schemas: duplicated schema " + schemaName);
        // VALIDATE SCHEMA
        this.schemas[schemaName] = schema;
    };
    return ATL;
}());
exports.ATL = ATL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQVRMLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQVRMLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUU5QixJQUFPLFVBQVUsV0FBVyxjQUFjLENBQUMsQ0FBQztBQUM1QyxJQUFPLENBQUMsV0FBVyxRQUFRLENBQUMsQ0FBQztBQUM3QixJQUFPLElBQUksV0FBVyxlQUFlLENBQUMsQ0FBQztBQUV2QyxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUU5QixFQUFFLENBQUMsQ0FBQyxPQUFPLE9BQU8sSUFBSSxVQUFVLENBQUM7SUFDL0IsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBZ0JwQztJQUFBO1FBQ0UsWUFBTyxHQUFnQjtZQUNyQixTQUFTLEVBQUUsRUFBRTtZQUNiLElBQUksRUFBRSxJQUFJO1lBQ1YsSUFBSSxFQUFFLElBQUk7WUFDVixjQUFjLEVBQUUsS0FBSztZQUNyQixJQUFJLEVBQUU7Z0JBQ0osUUFBUSxFQUFFLElBQUk7Z0JBQ2QsYUFBYSxFQUFFLElBQUk7Z0JBQ25CLE1BQU0sRUFBRSxJQUFJO2FBQ2I7U0FDRixDQUFDO1FBSUYsV0FBTSxHQUFnRCxFQUFFLENBQUM7UUFFekQsWUFBTyxHQUFnQyxFQUFFLENBQUM7SUFvSzVDLENBQUM7SUFsS0Msd0JBQVUsR0FBVixVQUFXLE1BQVc7UUFBdEIsaUJBc0lDO1FBcklDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sTUFBTSxLQUFLLFFBQVEsQ0FBQztZQUM3QixNQUFNLElBQUksU0FBUyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7UUFFM0Usc0JBQXNCO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzFCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sTUFBTSxDQUFDLFNBQVMsSUFBSSxRQUFRLENBQUM7Z0JBQ3RDLE1BQU0sSUFBSSxTQUFT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blxuaW1wb3J0IEFUTEhlbHBlcnMgPSByZXF1aXJlKCcuL0FUTEhlbHBlcnMnKTtcbmltcG9ydCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5pbXBvcnQgUkFNTCA9IHJlcXVpcmUoJ3JhbWwtMS1wYXJzZXInKTtcblxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmlmICh0eXBlb2YgUHJvbWlzZSAhPSAnZnVuY3Rpb24nKVxuICByZXF1aXJlKCdlczYtcHJvbWlzZScpLnBvbHlmaWxsKCk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUFUTE9wdGlvbnMge1xuICB2YXJpYWJsZXM/OiBBVExIZWxwZXJzLklEaWN0aW9uYXJ5PGFueT47XG4gIHBhdGg/OiBzdHJpbmc7XG4gIGZpbGU/OiBzdHJpbmc7XG4gIGJhc2VVcmk/OiBzdHJpbmc7XG4gIGJhc2VVcmlQYXJhbWV0ZXJzPzogQVRMSGVscGVycy5JRGljdGlvbmFyeTxzdHJpbmc+O1xuICBzZWxmU2lnbmVkQ2VydDogYm9vbGVhbjtcbiAgcmFtbDoge1xuICAgIGNvdmVyYWdlOiBib29sZWFuO1xuICAgIHJlc291cmNlVHlwZXM6IGJvb2xlYW47XG4gICAgdHJhaXRzOiBib29sZWFuO1xuICB9O1xufVxuXG5leHBvcnQgY2xhc3MgQVRMIHtcbiAgb3B0aW9uczogSUFUTE9wdGlvbnMgPSB7XG4gICAgdmFyaWFibGVzOiB7fSxcbiAgICBwYXRoOiBudWxsLFxuICAgIGZpbGU6IG51bGwsXG4gICAgc2VsZlNpZ25lZENlcnQ6IGZhbHNlLFxuICAgIHJhbWw6IHtcbiAgICAgIGNvdmVyYWdlOiB0cnVlLFxuICAgICAgcmVzb3VyY2VUeXBlczogdHJ1ZSxcbiAgICAgIHRyYWl0czogdHJ1ZVxuICAgIH1cbiAgfTtcblxuICByYW1sOiBSQU1MLmFwaTA4LkFwaSB8IFJBTUwuYXBpMTAuQXBpO1xuXG4gIHN1aXRlczogQVRMSGVscGVycy5JRGljdGlvbmFyeTxBVExIZWxwZXJzLkFUTFN1aXRlPiA9IHt9O1xuXG4gIHNjaGVtYXM6IEFUTEhlbHBlcnMuSURpY3Rpb25hcnk8YW55PiA9IHt9O1xuXG4gIGZyb21PYmplY3Qob2JqZWN0OiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIG9iamVjdCAhPT0gXCJvYmplY3RcIilcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJmcm9tT2JqZWN0OiB0aGUgZmlyc3QgcGFyYW1ldGVyIG11c3QgYmUgYW4gb2JqZWN0XCIpO1xuXG4gICAgLy8gbWVyZ2UgdGhlIHZhcmlhYmxlc1xuICAgIGlmICgndmFyaWFibGVzJyBpbiBvYmplY3QpIHtcbiAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnZhcmlhYmxlcyAhPSBcIm9iamVjdFwiKVxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiZnJvbU9iamVjdC52YXJpYWJsZXM6IE1VU1QgYmUgYW4gb2JqZWN0XCIpO1xuXG4gICAgICB0aGlzLm9wdGlvbnMudmFyaWFibGVzID0gXy5tZXJnZSh0aGlzLm9wdGlvbnMudmFyaWFibGVzIHx8IHt9LCBvYmplY3QudmFyaWFibGVzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5vcHRpb25zLnZhcmlhYmxlcyA9IHRoaXMub3B0aW9ucy52YXJpYWJsZXMgfHwge307XG4gICAgfVxuXG4gICAgLy8gb3ZlcnJpZGUgdmFyaWFibGVzLkVOViBpZiBub3QgZXhpc3RzIG9yIGlzIGFuIG9iamVjdFxuXG4gICAgaWYgKCF0aGlzLm9wdGlvbnMudmFyaWFibGVzWydFTlYnXSB8fCB0eXBlb2YgdGhpcy5vcHRpb25zLnZhcmlhYmxlc1snRU5WJ10gIT0gXCJvYmplY3RcIilcbiAgICAgIHRoaXMub3B0aW9ucy52YXJpYWJsZXNbJ0VOViddID0ge307XG5cbiAgICBfLmV4dGVuZCh0aGlzLm9wdGlvbnMudmFyaWFibGVzWydFTlYnXSwgXy5jbG9uZURlZXAocHJvY2Vzcy5lbnYpKTtcblxuICAgIC8vIHByZXBhcmUgdGhlIGJhc2VVcmlcbiAgICBpZiAoJ2Jhc2VVcmknIGluIG9iamVjdCkge1xuICAgICAgaWYgKHR5cGVvZiBvYmplY3QuYmFzZVVyaSA9PSBcInN0cmluZ1wiKVxuICAgICAgICB0aGlzLm9wdGlvbnMuYmFzZVVyaSA9IG9iamVjdC5iYXNlVXJpO1xuICAgICAgZWxzZVxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiYmFzZVVyaTogaW52YWxpZCB0eXBlXCIpO1xuXG4gICAgICBpZiAodGhpcy5vcHRpb25zLmJhc2VVcmkuc3Vic3RyKC0xKSA9PT0gJy8nKSB7XG4gICAgICAgIHRoaXMub3B0aW9ucy5iYXNlVXJpID0gdGhpcy5vcHRpb25zLmJhc2VVcmkuc3Vic3RyKDAsIHRoaXMub3B0aW9ucy5iYXNlVXJpLmxlbmd0aCAtIDEpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICgnb3B0aW9ucycgaW4gb2JqZWN0KSB7XG4gICAgICBBVExIZWxwZXJzLmVuc3VyZUluc3RhbmNlT2YoXCJvcHRpb25zXCIsIG9iamVjdC5vcHRpb25zLCBPYmplY3QpO1xuXG4gICAgICBPYmplY3Qua2V5cyhvYmplY3Qub3B0aW9ucykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBsZXQgdmFsdWUgPSBvYmplY3Qub3B0aW9uc1trZXldO1xuXG4gICAgICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICAgICAgY2FzZSAnc2VsZlNpZ25lZENlcnQnOlxuICAgICAgICAgICAgQVRMSGVscGVycy5lbnN1cmVJbnN0YW5jZU9mKFwib3B0aW9ucy5zZWxmU2lnbmVkQ2VydFwiLCB2YWx1ZSwgQm9vbGVhbik7XG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2VsZlNpZ25lZENlcnQgPSAhIXZhbHVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAncmFtbCc6XG4gICAgICAgICAgICBBVExIZWxwZXJzLmVuc3VyZUluc3RhbmNlT2YoXCJvcHRpb25zLnJhbWxcIiwgdmFsdWUsIE9iamVjdCk7XG4gICAgICAgICAgICBfLm1lcmdlKHRoaXMub3B0aW9ucy5yYW1sLCB2YWx1ZSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcInVua25vd24gb3B0aW9uOlwiICsga2V5KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCdiYXNlVXJpUGFyYW1ldGVycycgaW4gb2JqZWN0KSB7XG4gICAgICBpZiAoIW9iamVjdC5iYXNlVXJpUGFyYW1ldGVycyB8fCB0eXBlb2Ygb2JqZWN0LmJhc2VVcmlQYXJhbWV0ZXJzICE9IFwib2JqZWN0XCIgfHwgb2JqZWN0LmJhc2VVcmlQYXJhbWV0ZXJzIGluc3RhbmNlb2YgQXJyYXkpXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJiYXNlVXJpUGFyYW1ldGVyczogTVVTVCBiZSBhIGRpY3Rpb25hcnlcIik7XG5cbiAgICAgIHRoaXMub3B0aW9ucy5iYXNlVXJpUGFyYW1ldGVycyA9IF8uY2xvbmVEZWVwKG9iamVjdC5iYXNlVXJpUGFyYW1ldGVycyk7XG4gICAgfVxuXG4gICAgLy8gcGFyc2UgdGhlIHRlc3RzXG4gICAgaWYgKCd0ZXN0cycgaW4gb2JqZWN0KSB7XG4gICAgICBpZiAoIW9iamVjdC50ZXN0cyB8fCB0eXBlb2Ygb2JqZWN0LnRlc3RzICE9IFwib2JqZWN0XCIgfHwgb2JqZWN0LnRlc3RzIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcInRlc3RzOiBNVVNUIGJlIGEgZGljdGlvbmFyeVwiKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHN1aXRlOiBBVExIZWxwZXJzLkFUTFN1aXRlID0gbnVsbDtcblxuICAgICAgZm9yIChsZXQgc2VxdWVuY2VOYW1lIGluIG9iamVjdC50ZXN0cykge1xuICAgICAgICBzdWl0ZSA9IEFUTEhlbHBlcnMucGFyc2VTdWl0ZXMob2JqZWN0LnRlc3RzW3NlcXVlbmNlTmFtZV0sIHRoaXMpO1xuICAgICAgICBzdWl0ZS5uYW1lID0gc2VxdWVuY2VOYW1lO1xuXG4gICAgICAgIHRoaXMuc3VpdGVzW3N1aXRlLm5hbWVdID0gc3VpdGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCdzY2hlbWFzJyBpbiBvYmplY3QpIHtcbiAgICAgIGlmICghb2JqZWN0LnNjaGVtYXMgfHwgIShvYmplY3Quc2NoZW1hcyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwic2NoZW1hczogTVVTVCBiZSBhIGxpc3RcIik7XG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IHNlcXVlbmNlTmFtZSBpbiBvYmplY3Quc2NoZW1hcykge1xuICAgICAgICBsZXQgc2NoZW1hTmFtZTogc3RyaW5nID0gbnVsbDtcblxuICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5zY2hlbWFzW3NlcXVlbmNlTmFtZV0gPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgIC8vIGxvYWQgc3RyaW5nIHNjaGVtYSBieSBwYXRoXG4gICAgICAgICAgLy8gVE9ETywgbG9hZCBzY2hlbWFcbiAgICAgICAgICB0aGlzLl9hZGRTY2hlbWEoc2VxdWVuY2VOYW1lLCB7fSk7XG5cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqZWN0LnNjaGVtYXNbc2VxdWVuY2VOYW1lXSA9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgdGhpcy5fYWRkU2NoZW1hKHNjaGVtYU5hbWUsIG9iamVjdC5zY2hlbWFzW3NlcXVlbmNlTmFtZV0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJzY2hlbWFzOiBpbnZhbGlkIHNjaGVtYSBcIiArIHNlcXVlbmNlTmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoJ3JhbWwnIGluIG9iamVjdCkge1xuICAgICAgaWYgKCFvYmplY3QucmFtbCB8fCB0eXBlb2Ygb2JqZWN0LnJhbWwgIT0gXCJzdHJpbmdcIikge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwicmFtbDogTVVTVCBiZSBhIHN0cmluZ1wiKTtcbiAgICAgIH1cblxuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5yYW1sID0gUkFNTC5sb2FkQXBpU3luYyhvYmplY3QucmFtbCwgeyByZWplY3RPbkVycm9yczogdHJ1ZSB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUucGFyc2VyRXJyb3JzKSB7XG4gICAgICAgICAgdGhyb3cgcGF0aC5yZXNvbHZlKG9iamVjdC5yYW1sKSArICc6XFxuJyArIGUubWVzc2FnZSArIFwiXFxuXCIgKyBlLnBhcnNlckVycm9ycy5tYXAoeCA9PiBcIiAgXCIgKyB4Lm1lc3NhZ2UgKyBcIiBsaW5lIFwiICsgeC5saW5lKS5qb2luKFwiXFxuXCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUubG9nKHV0aWwuaW5zcGVjdChlKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNjaGVtYXMgPSB0aGlzLnJhbWwuc2NoZW1hcygpO1xuXG4gICAgICBmb3IgKGxldCBpIGluIHNjaGVtYXMpIHtcbiAgICAgICAgbGV0IHNjaGVtYUxpc3QgPSBzY2hlbWFzW2ldLnRvSlNPTigpO1xuICAgICAgICBmb3IgKGxldCBzY2hlbWFOYW1lIGluIHNjaGVtYUxpc3QpIHtcbiAgICAgICAgICBsZXQganNvbiA9IG51bGw7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGpzb24gPSBKU09OLnBhcnNlKHNjaGVtYUxpc3Rbc2NoZW1hTmFtZV0pO1xuICAgICAgICAgICAgdGhpcy5fYWRkU2NoZW1hKHNjaGVtYU5hbWUsIGpzb24pO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGUubWVzc2FnZSA9ICdFcnJvciBwYXJzaW5nIEpTT04gc2NoZW1hICcgKyBzY2hlbWFOYW1lICsgJ1xcblxcdCcgKyBlLm1lc3NhZ2UgKyAnXFxuJyArIHV0aWwuaW5zcGVjdChzY2hlbWFMaXN0W3NjaGVtYU5hbWVdKTtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChsZXQgc3VpdGVLZXkgaW4gdGhpcy5zdWl0ZXMpIHtcbiAgICAgIHRoaXMucmVwbGFjZVNjaGVtYSh0aGlzLnN1aXRlc1tzdWl0ZUtleV0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVwbGFjZVNjaGVtYShzdWl0ZTogQVRMSGVscGVycy5BVExTdWl0ZSkge1xuICAgIGlmIChzdWl0ZS50ZXN0ICYmIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keSAmJiBzdWl0ZS50ZXN0LnJlc3BvbnNlLmJvZHkuc2NoZW1hKSB7XG4gICAgICBpZiAodHlwZW9mIHN1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWEgPT0gXCJzdHJpbmdcIikge1xuICAgICAgICBpZiAoc3VpdGUudGVzdC5yZXNwb25zZS5ib2R5LnNjaGVtYSBpbiB0aGlzLnNjaGVtYXMpIHtcbiAgICAgICAgICBzdWl0ZS50ZXN0LnJlc3BvbnNlLmJvZHkuc2NoZW1hID0gdGhpcy5zY2hlbWFzW3N1aXRlLnRlc3QucmVzcG9uc2UuYm9keS5zY2hlbWFdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignc2NoZW1hICcgKyBzdWl0ZS50ZXN0LnJlc3BvbnNlLmJvZHkuc2NoZW1hICsgJyBub3QgZm91bmQgb24gdGVzdCAnICsgc3VpdGUudGVzdC5tZXRob2QgKyAnICcgKyBzdWl0ZS50ZXN0LnVyaSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc3VpdGUuc3VpdGVzKSB7XG4gICAgICBmb3IgKGxldCBzdWl0ZUtleSBpbiBzdWl0ZS5zdWl0ZXMpIHtcbiAgICAgICAgdGhpcy5yZXBsYWNlU2NoZW1hKHN1aXRlLnN1aXRlc1tzdWl0ZUtleV0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2FkZFNjaGVtYShzY2hlbWFOYW1lOiBzdHJpbmcsIHNjaGVtYTogYW55KSB7XG4gICAgaWYgKHNjaGVtYU5hbWUgaW4gdGhpcy5zY2hlbWFzKVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcInNjaGVtYXM6IGR1cGxpY2F0ZWQgc2NoZW1hIFwiICsgc2NoZW1hTmFtZSk7XG5cbiAgICAvLyBWQUxJREFURSBTQ0hFTUFcblxuICAgIHRoaXMuc2NoZW1hc1tzY2hlbWFOYW1lXSA9IHNjaGVtYTtcbiAgfVxufSJdfQ==