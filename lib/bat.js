"use strict";
// Node
var fs = require('fs');
var path = require('path');
// NPM
var jsYaml = require('js-yaml');
var _ = require('lodash');
var request = require('supertest');
var pathMatch = require('raml-path-match');
// Locals
var ATL = require('./ATL');
var ATLHelpers = require('./ATLHelpers');
var Coverage = require('./Coverage');
var RAMLCoverageReporter_1 = require('../lib/RAMLCoverageReporter');
var Bat = (function () {
    function Bat(options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        this.options = options;
        this.coverageElements = [];
        this.coverageData = {};
        this.ast = new ATL.ATL();
        var gotAST = ATLHelpers.flatPromise();
        this.loaderSemaphore = gotAST.promise;
        this._loaded = gotAST.resolver;
        this._loadedFailed = gotAST.rejecter;
        if (options.raw) {
            this.raw(options.raw);
        }
        else if (this.options.file) {
            this.load(options.file);
        }
        else {
            this.checkMochaContext()
                .then(function () { return _this.run(); });
        }
    }
    Bat.prototype.checkMochaContext = function () {
        var _this = this;
        var gotContext = ATLHelpers.flatPromise();
        describe('Checking mocha context', function () {
            gotContext.resolver(this.ctx);
        });
        // check for context configurations
        return gotContext.promise.then(function (ctx) {
            if (ctx) {
                ctx = ctx.config || ctx;
                if (ctx.batFile) {
                    _this.load(ctx.batFile);
                }
                else if (ctx.rawBat) {
                    _this.raw(ctx.rawBat);
                }
                if (ctx.baseUri) {
                    _this.options.baseUri = ctx.baseUri;
                }
                if (ctx.variables) {
                    _this.options.variables = _this.options.variables || {};
                    _.merge(_this.options.variables, ctx.variables);
                }
            }
        });
    };
    Bat.prototype.updateState = function () {
        if (this.options.variables) {
            _.merge(this.ast.options.variables, this.options.variables);
        }
        if (this.options.baseUri && this.options.baseUri != 'default') {
            this.ast.options.baseUri = this.options.baseUri;
        }
    };
    Bat.prototype.load = function (file) {
        this.path = path.dirname(file);
        process.chdir(this.path);
        this.file = file;
        this.raw(fs.readFileSync(this.file, 'utf8'));
    };
    Bat.prototype.raw = function (content) {
        try {
            var parsed = jsYaml.load(content, {
                schema: ATLHelpers.pointerLib.createSchema()
            });
            this.ast.options.path = this.path;
            this.ast.fromObject(parsed);
            this.updateState();
            this._loaded();
            // Parse the raml for coverage
            if (this.ast.raml) {
                var resources = this.ast.raml.resources();
                for (var r in resources) {
                    this.peekResource(resources[r]);
                }
            }
        }
        catch (e) {
            if (this.options.file)
                e.message = this.options.file + '\n' + e.message;
            throw e;
        }
    };
    Bat.prototype.run = function (app) {
        var _this = this;
        var prom = ATLHelpers.flatPromise();
        try {
            if (this.ast.options.selfSignedCert) {
                process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
            }
            if (this.options.baseUri == 'default')
                delete this.options.baseUri;
            if (!app || app === "default" || app === '') {
                app = this.options.baseUri || this.ast.options.baseUri;
            }
            if (!app) {
                throw new Error("baseUri not specified");
            }
            if (typeof app === 'string' && app.substr(-1) === '/') {
                app = app.substr(0, app.length - 1);
            }
            this.ast.agent = request.agent(app);
            // Run tests
            var tests = this.allTests();
            var allDone_1 = [];
            tests.forEach(function (test) {
                var testResult = test.run();
                allDone_1.push(testResult
                    .then(function (result) { return Promise.resolve({
                    response: result,
                    success: true
                }); })
                    .catch(function (result) { return Promise.resolve({
                    response: result,
                    success: false
                }); }));
                testResult.then(function (res) {
                    _this.registerTestResult(test, {
                        req: test.requester.superAgentRequest,
                        res: test.requester.superAgentResponse,
                        test: test,
                        url: test.requester.url
                    });
                });
            });
            Promise.all(allDone_1).then(function () { return prom.resolver(); });
        }
        catch (e) {
            prom.rejecter(e);
        }
        return prom.promise;
    };
    Bat.prototype.peekResource = function (resource, parent) {
        var thisUrl = (parent || "") + resource.relativeUri().value();
        this.coverageElements.push(new Coverage.CoverageResource(resource, this));
        var resources = resource.resources();
        for (var r in resources) {
            this.peekResource(resources[r], thisUrl);
        }
    };
    Bat.prototype.registerTestResult = function (test, ctx) {
        var key = ATLHelpers.matchUrl(test.uri);
        this.coverageElements.forEach(function (coverageElement) {
            if (coverageElement.matches(ctx.url)) {
                coverageElement.resolve(ctx.test, ctx.res);
            }
        });
    };
    Bat.prototype.allTests = function () {
        var tests = [];
        var walk = function (suite) {
            if (suite.test)
                tests.push(suite.test);
            if (suite.suites && Object.keys(suite.suites).length) {
                for (var k in suite.suites)
                    walk(suite.suites[k]);
            }
        };
        for (var suite_1 in this.ast.suites)
            walk(this.ast.suites[suite_1]);
        return tests;
    };
    Bat.prototype.writeCoverage = function (coverFile) {
        var _this = this;
        var cwd = path.dirname(coverFile);
        if (this.coverageData && Object.keys(this.coverageData).length) {
            console.info("Writing coverage information: " + coverFile);
            var coverage = '';
            try {
                fs.mkdirSync(cwd);
            }
            catch (e) { }
            try {
                coverage = fs.readFileSync(coverFile).toString();
            }
            catch (e) {
            }
            if (coverage.length)
                coverage = coverage + '\n';
            coverage =
                coverage += Object.keys(this.coverageData)
                    .filter(function (x) { return !!x; })
                    .map(function (file) {
                    return RAMLCoverageReporter_1.generateString(file, _this.coverageData[file]);
                }).join('\n');
            fs.writeFileSync(coverFile, coverage);
            console.info("Writing coverage information. OK!");
        }
    };
    return Bat;
}());
exports.Bat = Bat;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmF0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPO0FBQ1AsSUFBTyxFQUFFLFdBQVcsSUFBSSxDQUFDLENBQUM7QUFDMUIsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFJOUIsTUFBTTtBQUNOLElBQU8sTUFBTSxXQUFXLFNBQVMsQ0FBQyxDQUFDO0FBQ25DLElBQU8sQ0FBQyxXQUFXLFFBQVEsQ0FBQyxDQUFDO0FBQzdCLElBQU8sT0FBTyxXQUFXLFdBQVcsQ0FBQyxDQUFDO0FBSXRDLElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRzdDLFNBQVM7QUFDVCxJQUFPLEdBQUcsV0FBVyxPQUFPLENBQUMsQ0FBQztBQUM5QixJQUFPLFVBQVUsV0FBVyxjQUFjLENBQUMsQ0FBQztBQUM1QyxJQUFPLFFBQVEsV0FBVyxZQUFZLENBQUMsQ0FBQztBQUN4QyxxQ0FBbUQsNkJBQTZCLENBQUMsQ0FBQTtBQVdqRjtJQVlFLGFBQW1CLE9BQXlCO1FBWjlDLGlCQThQQztRQWxQYSx1QkFBZ0MsR0FBaEMsWUFBZ0M7UUFBekIsWUFBTyxHQUFQLE9BQU8sQ0FBa0I7UUFGNUMscUJBQWdCLEdBQWdDLEVBQUUsQ0FBQztRQWdObkQsaUJBQVksR0FFUCxFQUFFLENBQUM7UUEvTU4sSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUV6QixJQUFJLE1BQU0sR0FBRyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFdEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUMvQixJQUFJLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFFckMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFD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O1lBRWxCLElBQUksQ0FBQztnQkFDSCxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BCLENBQUU7WUFBQSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVmLElBQUksQ0FBQztnQkFDSCxRQUFRLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuRCxDQUFFO1lBQUEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUViLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO2dCQUFDLFFBQVEsR0FBRyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBRWhELFFBQVE7Z0JBQ04sUUFBUSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztxQkFDdkMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLENBQUMsRUFBSCxDQUFHLENBQUM7cUJBQ2hCLEdBQUcsQ0FBQyxVQUFDLElBQUk7b0JBQ1IsTUFBTSxDQUFDLHFDQUFnQixDQUFDLElBQUksRUFBRSxLQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBUSxDQUFDLENBQUM7Z0JBQ2hFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVsQixFQUFFLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUV0QyxPQUFPLENBQUMsSUFBSSxDQUFDLG1DQUFtQyxDQUFDLENBQUM7UUFDcEQsQ0FBQztJQUNILENBQUM7SUFDSCxVQUFDO0FBQUQsQ0FBQyxBQTlQRCxJQThQQztBQTlQWSxXQUFHLE1BOFBmLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBOb2RlXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgdXJsID0gcmVxdWlyZSgndXJsJyk7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcblxuLy8gTlBNXG5pbXBvcnQganNZYW1sID0gcmVxdWlyZSgnanMteWFtbCcpO1xuaW1wb3J0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmltcG9ydCByZXF1ZXN0ID0gcmVxdWlyZSgnc3VwZXJ0ZXN0Jyk7XG5pbXBvcnQgc3VwZXJBZ2VudCA9IHJlcXVpcmUoJ3N1cGVyYWdlbnQnKTtcbmltcG9ydCBleHBlY3QgPSByZXF1aXJlKCdleHBlY3QnKTtcbmltcG9ydCBSQU1MID0gcmVxdWlyZSgncmFtbC0xLXBhcnNlcicpO1xuY29uc3QgcGF0aE1hdGNoID0gcmVxdWlyZSgncmFtbC1wYXRoLW1hdGNoJyk7XG5pbXBvcnQgeyBSZXF1ZXN0IH0gZnJvbSAnc3VwZXJhZ2VudCc7XG5cbi8vIExvY2Fsc1xuaW1wb3J0IEFUTCA9IHJlcXVpcmUoJy4vQVRMJyk7XG5pbXBvcnQgQVRMSGVscGVycyA9IHJlcXVpcmUoJy4vQVRMSGVscGVycycpO1xuaW1wb3J0IENvdmVyYWdlID0gcmVxdWlyZSgnLi9Db3ZlcmFnZScpO1xuaW1wb3J0IHsgZ2VuZXJhdGVTdHJpbmcgYXMgY292ZXJhZ2VUb1N0cmluZyB9IGZyb20gJy4uL2xpYi9SQU1MQ292ZXJhZ2VSZXBvcnRlcic7XG5pbXBvcnQgeyBBVExFcnJvciwgQVRMU2tpcHBlZCwgQ29tbW9uQXNzZXJ0aW9ucyB9IGZyb20gJy4vQVRMQXNzZXJ0aW9uJztcblxuXG5leHBvcnQgaW50ZXJmYWNlIElCYXRPcHRpb25zIHtcbiAgYmFzZVVyaT86IHN0cmluZztcbiAgdmFyaWFibGVzPzogQVRMSGVscGVycy5JRGljdGlvbmFyeTxhbnk+O1xuICBmaWxlPzogc3RyaW5nO1xuICByYXc/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBCYXQge1xuICBwYXRoOiBzdHJpbmc7XG4gIGZpbGU6IHN0cmluZztcblxuICBhc3Q6IEFUTC5BVEw7XG5cbiAgcHJpdmF0ZSBfbG9hZGVkOiBGdW5jdGlvbjtcbiAgcHJpdmF0ZSBfbG9hZGVkRmFpbGVkOiBGdW5jdGlvbjtcbiAgbG9hZGVyU2VtYXBob3JlOiBQcm9taXNlPGFueT47XG5cbiAgY292ZXJhZ2VFbGVtZW50czogQ292ZXJhZ2UuQ292ZXJhZ2VSZXNvdXJjZVtdID0gW107XG5cbiAgY29uc3RydWN0b3IocHVibGljIG9wdGlvbnM6IElCYXRPcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmFzdCA9IG5ldyBBVEwuQVRMKCk7XG5cbiAgICBsZXQgZ290QVNUID0gQVRMSGVscGVycy5mbGF0UHJvbWlzZSgpO1xuXG4gICAgdGhpcy5sb2FkZXJTZW1hcGhvcmUgPSBnb3RBU1QucHJvbWlzZTtcbiAgICB0aGlzLl9sb2FkZWQgPSBnb3RBU1QucmVzb2x2ZXI7XG4gICAgdGhpcy5fbG9hZGVkRmFpbGVkID0gZ290QVNULnJlamVjdGVyO1xuXG4gICAgaWYgKG9wdGlvbnMucmF3KSB7XG4gICAgICB0aGlzLnJhdyhvcHRpb25zLnJhdyk7XG4gICAgfSBlbHNlIGlmICh0aGlzLm9wdGlvbnMuZmlsZSkge1xuICAgICAgdGhpcy5sb2FkKG9wdGlvbnMuZmlsZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2hlY2tNb2NoYUNvbnRleHQoKVxuICAgICAgICAudGhlbigoKSA9PiB0aGlzLnJ1bigpKTtcbiAgICB9XG4gIH1cblxuICBjaGVja01vY2hhQ29udGV4dCgpIHtcblxuICAgIGxldCBnb3RDb250ZXh0ID0gQVRMSGVscGVycy5mbGF0UHJvbWlzZSgpO1xuXG4gICAgZGVzY3JpYmUoJ0NoZWNraW5nIG1vY2hhIGNvbnRleHQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBnb3RDb250ZXh0LnJlc29sdmVyKHRoaXMuY3R4KTtcbiAgICB9KTtcblxuICAgIC8vIGNoZWNrIGZvciBjb250ZXh0IGNvbmZpZ3VyYXRpb25zXG4gICAgcmV0dXJuIGdvdENvbnRleHQucHJvbWlzZS50aGVuKGN0eCA9PiB7XG4gICAgICBpZiAoY3R4KSB7XG4gICAgICAgIGN0eCA9IGN0eC5jb25maWcgfHwgY3R4O1xuXG4gICAgICAgIGlmIChjdHguYmF0RmlsZSkge1xuICAgICAgICAgIHRoaXMubG9hZChjdHguYmF0RmlsZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoY3R4LnJhd0JhdCkge1xuICAgICAgICAgIHRoaXMucmF3KGN0eC5yYXdCYXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGN0eC5iYXNlVXJpKSB7XG4gICAgICAgICAgdGhpcy5vcHRpb25zLmJhc2VVcmkgPSBjdHguYmFzZVVyaTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjdHgudmFyaWFibGVzKSB7XG4gICAgICAgICAgdGhpcy5vcHRpb25zLnZhcmlhYmxlcyA9IHRoaXMub3B0aW9ucy52YXJpYWJsZXMgfHwge307XG4gICAgICAgICAgXy5tZXJnZSh0aGlzLm9wdGlvbnMudmFyaWFibGVzLCBjdHgudmFyaWFibGVzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTdGF0ZSgpIHtcbiAgICBpZiAodGhpcy5vcHRpb25zLnZhcmlhYmxlcykge1xuICAgICAgXy5tZXJnZSh0aGlzLmFzdC5vcHRpb25zLnZhcmlhYmxlcywgdGhpcy5vcHRpb25zLnZhcmlhYmxlcyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0aW9ucy5iYXNlVXJpICYmIHRoaXMub3B0aW9ucy5iYXNlVXJpICE9ICdkZWZhdWx0Jykge1xuICAgICAgdGhpcy5hc3Qub3B0aW9ucy5iYXNlVXJpID0gdGhpcy5vcHRpb25zLmJhc2VVcmk7XG4gICAgfVxuICB9XG5cbiAgbG9hZChmaWxlOiBzdHJpbmcpIHtcbiAgICB0aGlzLnBhdGggPSBwYXRoLmRpcm5hbWUoZmlsZSk7XG4gICAgcHJvY2Vzcy5jaGRpcih0aGlzLnBhdGgpO1xuICAgIHRoaXMuZmlsZSA9IGZpbGU7XG5cbiAgICB0aGlzLnJhdyhmcy5yZWFkRmlsZVN5bmModGhpcy5maWxlLCAndXRmOCcpKTtcbiAgfVxuXG4gIHJhdyhjb250ZW50OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IHBhcnNlZCA9IGpzWWFtbC5sb2FkKGNvbnRlbnQsIHtcbiAgICAgICAgc2NoZW1hOiBBVExIZWxwZXJzLnBvaW50ZXJMaWIuY3JlYXRlU2NoZW1hKClcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmFzdC5vcHRpb25zLnBhdGggPSB0aGlzLnBhdGg7XG4gICAgICB0aGlzLmFzdC5mcm9tT2JqZWN0KHBhcnNlZCk7XG5cbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoKTtcblxuICAgICAgdGhpcy5fbG9hZGVkKCk7XG5cbiAgICAgIC8vIFBhcnNlIHRoZSByYW1sIGZvciBjb3ZlcmFnZVxuICAgICAgaWYgKHRoaXMuYXN0LnJhbWwpIHtcbiAgICAgICAgbGV0IHJlc291cmNlcyA9IHRoaXMuYXN0LnJhbWwucmVzb3VyY2VzKCk7XG5cbiAgICAgICAgZm9yIChsZXQgciBpbiByZXNvdXJjZXMpIHtcbiAgICAgICAgICB0aGlzLnBlZWtSZXNvdXJjZShyZXNvdXJjZXNbcl0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHRoaXMub3B0aW9ucy5maWxlKVxuICAgICAgICBlLm1lc3NhZ2UgPSB0aGlzLm9wdGlvbnMuZmlsZSArICdcXG4nICsgZS5tZXNzYWdlO1xuXG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIHJ1bihhcHA/KTogUHJvbWlzZTxCYXQ+IHtcbiAgICBsZXQgcHJvbSA9IEFUTEhlbHBlcnMuZmxhdFByb21pc2UoKTtcblxuICAgIHRyeSB7XG4gICAgICBpZiAodGhpcy5hc3Qub3B0aW9ucy5zZWxmU2lnbmVkQ2VydCkge1xuICAgICAgICBwcm9jZXNzLmVudi5OT0RFX1RMU19SRUpFQ1RfVU5BVVRIT1JJWkVEID0gXCIwXCI7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuYmFzZVVyaSA9PSAnZGVmYXVsdCcpXG4gICAgICAgIGRlbGV0ZSB0aGlzLm9wdGlvbnMuYmFzZVVyaTtcblxuICAgICAgaWYgKCFhcHAgfHwgYXBwID09PSBcImRlZmF1bHRcIiB8fCBhcHAgPT09ICcnKSB7XG4gICAgICAgIGFwcCA9IHRoaXMub3B0aW9ucy5iYXNlVXJpIHx8IHRoaXMuYXN0Lm9wdGlvbnMuYmFzZVVyaTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFhcHApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYmFzZVVyaSBub3Qgc3BlY2lmaWVkXCIpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIGFwcCA9PT0gJ3N0cmluZycgJiYgYXBwLnN1YnN0cigtMSkgPT09ICcvJykge1xuICAgICAgICBhcHAgPSBhcHAuc3Vic3RyKDAsIGFwcC5sZW5ndGggLSAxKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5hc3QuYWdlbnQgPSByZXF1ZXN0LmFnZW50KGFwcCk7XG5cbiAgICAgIC8vIFJ1biB0ZXN0c1xuXG4gICAgICBsZXQgdGVzdHMgPSB0aGlzLmFsbFRlc3RzKCk7XG4gICAgICBsZXQgYWxsRG9uZSA9IFtdO1xuXG4gICAgICB0ZXN0cy5mb3JFYWNoKHRlc3QgPT4ge1xuICAgICAgICBsZXQgdGVzdFJlc3VsdCA9IHRlc3QucnVuKCk7XG5cbiAgICAgICAgYWxsRG9uZS5wdXNoKFxuICAgICAgICAgIHRlc3RSZXN1bHRcbiAgICAgICAgICAgIC50aGVuKHJlc3VsdCA9PiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgICAgICByZXNwb25zZTogcmVzdWx0LFxuICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgICAgIC5jYXRjaChyZXN1bHQgPT4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgICAgICAgcmVzcG9uc2U6IHJlc3VsdCxcbiAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2VcbiAgICAgICAgICAgIH0pKVxuICAgICAgICApO1xuXG4gICAgICAgIHRlc3RSZXN1bHQudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHRoaXMucmVnaXN0ZXJUZXN0UmVzdWx0KHRlc3QsIHtcbiAgICAgICAgICAgIHJlcTogdGVzdC5yZXF1ZXN0ZXIuc3VwZXJBZ2VudFJlcXVlc3QsXG4gICAgICAgICAgICByZXM6IHRlc3QucmVxdWVzdGVyLnN1cGVyQWdlbnRSZXNwb25zZSxcbiAgICAgICAgICAgIHRlc3Q6IHRlc3QsXG4gICAgICAgICAgICB1cmw6IHRlc3QucmVxdWVzdGVyLnVybFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBQcm9taXNlLmFsbChhbGxEb25lKS50aGVuKCgpID0+IHByb20ucmVzb2x2ZXIoKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcHJvbS5yZWplY3RlcihlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvbS5wcm9taXNlO1xuICB9XG5cbiAgcHJpdmF0ZSBwZWVrUmVzb3VyY2UocmVzb3VyY2U6IFJBTUwuYXBpMDguUmVzb3VyY2UgfCBSQU1MLmFwaTEwLlJlc291cmNlLCBwYXJlbnQ/OiBzdHJpbmcpIHtcbiAgICBsZXQgdGhpc1VybCA9IChwYXJlbnQgfHwgXCJcIikgKyByZXNvdXJjZS5yZWxhdGl2ZVVyaSgpLnZhbHVlKCk7XG5cbiAgICB0aGlzLmNvdmVyYWdlRWxlbWVudHMucHVzaChuZXcgQ292ZXJhZ2UuQ292ZXJhZ2VSZXNvdXJjZShyZXNvdXJjZSBhcyBhbnksIHRoaXMpKTtcblxuICAgIGxldCByZXNvdXJjZXMgPSByZXNvdXJjZS5yZXNvdXJjZXMoKTtcblxuICAgIGZvciAobGV0IHIgaW4gcmVzb3VyY2VzKSB7XG4gICAgICB0aGlzLnBlZWtSZXNvdXJjZShyZXNvdXJjZXNbcl0sIHRoaXNVcmwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJUZXN0UmVzdWx0KHRlc3Q6IEFUTEhlbHBlcnMuQVRMVGVzdCwgY3R4OiB7XG4gICAgcmVxOiBzdXBlckFnZW50LlN1cGVyQWdlbnRSZXF1ZXN0O1xuICAgIHJlczogc3VwZXJBZ2VudC5SZXNwb25zZTtcbiAgICB0ZXN0OiBBVExIZWxwZXJzLkFUTFRlc3Q7XG4gICAgdXJsOiBzdHJpbmc7XG4gIH0pIHtcbiAgICBsZXQga2V5ID0gQVRMSGVscGVycy5tYXRjaFVybCh0ZXN0LnVyaSk7XG5cbiAgICB0aGlzLmNvdmVyYWdlRWxlbWVudHMuZm9yRWFjaChjb3ZlcmFnZUVsZW1lbnQgPT4ge1xuICAgICAgaWYgKGNvdmVyYWdlRWxlbWVudC5tYXRjaGVzKGN0eC51cmwpKSB7XG4gICAgICAgIGNvdmVyYWdlRWxlbWVudC5yZXNvbHZlKGN0eC50ZXN0LCBjdHgucmVzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFsbFRlc3RzKCk6IEFUTEhlbHBlcnMuQVRMVGVzdFtdIHtcbiAgICBsZXQgdGVzdHMgPSBbXTtcblxuICAgIGNvbnN0IHdhbGsgPSAoc3VpdGU6IEFUTEhlbHBlcnMuQVRMU3VpdGUpID0+IHtcbiAgICAgIGlmIChzdWl0ZS50ZXN0KVxuICAgICAgICB0ZXN0cy5wdXNoKHN1aXRlLnRlc3QpO1xuXG4gICAgICBpZiAoc3VpdGUuc3VpdGVzICYmIE9iamVjdC5rZXlzKHN1aXRlLnN1aXRlcykubGVuZ3RoKSB7XG4gICAgICAgIGZvciAobGV0IGsgaW4gc3VpdGUuc3VpdGVzKVxuICAgICAgICAgIHdhbGsoc3VpdGUuc3VpdGVzW2tdKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgZm9yIChsZXQgc3VpdGUgaW4gdGhpcy5hc3Quc3VpdGVzKVxuICAgICAgd2Fsayh0aGlzLmFzdC5zdWl0ZXNbc3VpdGVdKTtcblxuICAgIHJldHVybiB0ZXN0cztcbiAgfVxuXG4gIGNvdmVyYWdlRGF0YTogQVRMSGVscGVycy5JRGljdGlvbmFyeTx7XG4gICAgc291cmNlOiBBcnJheTxudW1iZXIgfCB2b2lkPjtcbiAgfT4gPSB7fTtcblxuICB3cml0ZUNvdmVyYWdlKGNvdmVyRmlsZTogc3RyaW5nKSB7XG4gICAgbGV0IGN3ZCA9IHBhdGguZGlybmFtZShjb3ZlckZpbGUpO1xuXG4gICAgaWYgKHRoaXMuY292ZXJhZ2VEYXRhICYmIE9iamVjdC5rZXlzKHRoaXMuY292ZXJhZ2VEYXRhKS5sZW5ndGgpIHtcbiAgICAgIGNvbnNvbGUuaW5mbyhcIldyaXRpbmcgY292ZXJhZ2UgaW5mb3JtYXRpb246IFwiICsgY292ZXJGaWxlKTtcblxuICAgICAgbGV0IGNvdmVyYWdlID0gJyc7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGZzLm1rZGlyU3luYyhjd2QpO1xuICAgICAgfSBjYXRjaCAoZSkgeyB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvdmVyYWdlID0gZnMucmVhZEZpbGVTeW5jKGNvdmVyRmlsZSkudG9TdHJpbmcoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcblxuICAgICAgfVxuXG4gICAgICBpZiAoY292ZXJhZ2UubGVuZ3RoKSBjb3ZlcmFnZSA9IGNvdmVyYWdlICsgJ1xcbic7XG5cbiAgICAgIGNvdmVyYWdlID1cbiAgICAgICAgY292ZXJhZ2UgKz0gT2JqZWN0LmtleXModGhpcy5jb3ZlcmFnZURhdGEpXG4gICAgICAgICAgLmZpbHRlcih4ID0+ICEheClcbiAgICAgICAgICAubWFwKChmaWxlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gY292ZXJhZ2VUb1N0cmluZyhmaWxlLCB0aGlzLmNvdmVyYWdlRGF0YVtmaWxlXSBhcyBhbnkpO1xuICAgICAgICAgIH0pLmpvaW4oJ1xcbicpO1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGNvdmVyRmlsZSwgY292ZXJhZ2UpO1xuXG4gICAgICBjb25zb2xlLmluZm8oXCJXcml0aW5nIGNvdmVyYWdlIGluZm9ybWF0aW9uLiBPSyFcIik7XG4gICAgfVxuICB9XG59Il19