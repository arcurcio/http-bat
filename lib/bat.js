"use strict";
// Node
var fs = require('fs');
var path = require('path');
var util = require('util');
// NPM
var jsYaml = require('js-yaml');
var _ = require('lodash');
var request = require('supertest');
var jsonschema = require('jsonschema');
var pathMatch = require('raml-path-match');
// Locals
var ATL = require('./ATL');
var ATLHelpers = require('./ATLHelpers');
var Coverage = require('./Coverage');
var RAMLCoverageReporter_1 = require('../lib/RAMLCoverageReporter');
var Bat = (function () {
    function Bat(options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        this.options = options;
        this.describe = describe;
        this.it = it;
        this.coverageElements = [];
        this.coverageData = {};
        this.ast = new ATL.ATL();
        var gotAST = ATLHelpers.flatPromise();
        this.loaderSemaphore = gotAST.promise;
        this._loaded = gotAST.resolver;
        this._loadedFailed = gotAST.rejecter;
        if (options.raw) {
            this.raw(options.raw);
        }
        else if (this.options.file) {
            this.load(options.file);
        }
        else {
            this.checkMochaContext()
                .then(function () { return _this.run(); });
        }
    }
    Bat.prototype.checkMochaContext = function () {
        var _this = this;
        var gotContext = ATLHelpers.flatPromise();
        this.describe('Checking mocha context', function () {
            gotContext.resolver(this.ctx);
        });
        // check for context configurations
        return gotContext.promise.then(function (ctx) {
            if (ctx) {
                ctx = ctx.config || ctx;
                if (ctx.batFile) {
                    _this.load(ctx.batFile);
                }
                else if (ctx.rawBat) {
                    _this.raw(ctx.rawBat);
                }
                if (ctx.baseUri) {
                    _this.options.baseUri = ctx.baseUri;
                }
                if (ctx.variables) {
                    _this.options.variables = _this.options.variables || {};
                    _.merge(_this.options.variables, ctx.variables);
                }
            }
        });
    };
    Bat.prototype.updateState = function () {
        if (this.options.variables) {
            _.merge(this.ast.options.variables, this.options.variables);
        }
        if (this.options.baseUri && this.options.baseUri != 'default') {
            this.ast.options.baseUri = this.options.baseUri;
        }
    };
    Bat.prototype.load = function (file) {
        this.path = path.dirname(file);
        process.chdir(this.path);
        this.file = file;
        this.raw(fs.readFileSync(this.file, 'utf8'));
    };
    Bat.prototype.raw = function (content) {
        try {
            var parsed = jsYaml.load(content, {
                schema: ATLHelpers.pointerLib.createSchema()
            });
            this.ast.options.path = this.path;
            this.ast.fromObject(parsed);
            this.updateState();
            this._loaded();
        }
        catch (e) {
            if (this.options.file)
                e.message = this.options.file + '\n' + e.message;
            throw e;
        }
    };
    Bat.prototype.run = function (app) {
        var _this = this;
        var prom = ATLHelpers.flatPromise();
        this.describe(this.file || 'http-bat', function () {
            if (_this.ast.options.selfSignedCert) {
                _this.it('Allowing self signed server certificates', function (done) {
                    process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
                    done();
                });
            }
            if (_this.options.baseUri == 'default')
                delete _this.options.baseUri;
            if (!app || app === "default" || app === '') {
                app = _this.options.baseUri || _this.ast.options.baseUri;
            }
            if (!app) {
                throw new Error("baseUri not specified");
            }
            if (typeof app === 'string' && app.substr(-1) === '/') {
                app = app.substr(0, app.length - 1);
            }
            _this.ast.agent = request.agent(app);
            // Parse the raml for coverage
            if (_this.ast.raml) {
                var resources = _this.ast.raml.resources();
                for (var r in resources) {
                    _this.peekResource(resources[r]);
                }
            }
            // Run suites
            for (var k in _this.ast.suites) {
                var suite_1 = _this.ast.suites[k];
                _this.runSuite(suite_1);
            }
            _this.ensureRamlCoverage();
            _this.deferedIt('Finalize ATL Document').then(function (done) {
                prom.resolver();
                done();
            });
        });
        return prom.promise;
    };
    Bat.prototype.ensureRamlCoverage = function () {
        var _this = this;
        if (this.ast.raml) {
            this.describe("RAML Coverage", function () {
                _this.it('Wait the results before start', function (done) {
                    Promise.all(_this.coverageElements.map(function (item) { return item.run(); }))
                        .then(function () { return done(); })
                        .catch(function (err) { return done(err); });
                });
                if (_this.ast.options.raml.coverage) {
                    _this.coverageElements.forEach(function (x) { return x.injectMochaTests(); });
                }
                it('Print coverage', function (done) {
                    Promise.all(_this.coverageElements.map(function (x) { return x.getCoverage(); }))
                        .then(function (x) {
                        var total = x.reduce(function (prev, actual) {
                            prev.errored += actual.errored;
                            prev.total += actual.total;
                            prev.notCovered += actual.notCovered;
                            return prev;
                        }, { total: 0, errored: 0, notCovered: 0 });
                        console.log(util.inspect(total, false, 2, true));
                        done();
                    });
                });
            });
        }
    };
    Bat.prototype.peekResource = function (resource, parent) {
        var thisUrl = (parent || "") + resource.relativeUri().value();
        this.coverageElements.push(new Coverage.CoverageResource(resource, this));
        var resources = resource.resources();
        for (var r in resources) {
            this.peekResource(resources[r], thisUrl);
        }
    };
    Bat.prototype.registerTestResult = function (test, ctx) {
        var key = ATLHelpers.matchUrl(test.uri);
        this.coverageElements.forEach(function (coverageElement) {
            if (coverageElement.matches(ctx.url)) {
                coverageElement.resolve(ctx.test, ctx.res);
            }
        });
    };
    Bat.prototype.runSuite = function (suite) {
        var _this = this;
        var execFn = suite.skip ? this.describe.skip : this.describe;
        var promises = [];
        if (suite.test) {
            // this.runTest(suite.test);
            var testResult = suite.test.run();
            promises.push(testResult);
            testResult.then(function (res) {
                _this.registerTestResult(suite.test, {
                    req: suite.test.requester.superAgentRequest,
                    res: suite.test.requester.superAgentResponse,
                    test: suite.test,
                    url: suite.test.requester.url
                });
            });
            generateMochaTest(suite.test);
        }
        var that = this;
        if (suite.suites && Object.keys(suite.suites).length) {
            execFn(suite.name, function () {
                for (var k in suite.suites) {
                    var s = suite.suites[k];
                    promises = promises.concat(that.runSuite(s));
                }
            });
        }
        return Promise.all(promises);
    };
    Bat.prototype.obtainSchemaValidator = function (schema) {
        var v = new jsonschema.Validator();
        if (typeof schema == "string") {
            if (schema in this.ast.schemas) {
                v.addSchema(this.ast.schemas[schema], schema);
                schema = this.ast.schemas[schema];
            }
            else {
                try {
                    schema = JSON.parse(schema);
                    v.addSchema(schema);
                }
                catch (e) {
                }
            }
        }
        else if (typeof schema == "object") {
            v.addSchema(schema);
        }
        else {
            throw new Error('Invalid schema ' + util.inspect(schema));
        }
        if (v.unresolvedRefs && v.unresolvedRefs.length) {
            this.describe("Load referenced schemas", function () {
                var _this = this;
                var _loop_1 = function() {
                    var nextSchema = v.unresolvedRefs.shift();
                    this_1.it("load schema " + nextSchema, function () {
                        var theSchema = _this.ast.schemas[nextSchema];
                        if (!theSchema)
                            throw new Error("schema " + nextSchema + " not found");
                        v.addSchema(theSchema, nextSchema);
                    });
                };
                var this_1 = this;
                while (v.unresolvedRefs && v.unresolvedRefs.length) {
                    _loop_1();
                }
            });
        }
        return function (content) {
            return v.validate(content, schema);
        };
    };
    Bat.prototype.deferedIt = function (name, timeout) {
        var fill = null;
        var prom = ATLHelpers.flatPromise();
        this.it(name, function (done) {
            if (timeout)
                this.timeout(timeout);
            prom.resolver.call(this, function (ret) {
                /* istanbul ignore if */
                if (ret) {
                    if (done.fail)
                        done.fail(ret);
                    else
                        done(ret);
                }
                else {
                    done();
                }
            });
            prom.promise.catch(done);
        });
        return prom.promise;
    };
    Bat.prototype.writeCoverage = function (coverFile) {
        var _this = this;
        var cwd = path.dirname(coverFile);
        if (this.coverageData && Object.keys(this.coverageData).length) {
            console.info("Writing coverage information: " + coverFile);
            var coverage = '';
            try {
                fs.mkdirSync(cwd);
            }
            catch (e) { }
            try {
                coverage = fs.readFileSync(coverFile).toString();
            }
            catch (e) {
            }
            if (coverage.length)
                coverage = coverage + '\n';
            coverage =
                coverage += Object.keys(this.coverageData)
                    .filter(function (x) { return !!x; })
                    .map(function (file) {
                    return RAMLCoverageReporter_1.generateString(file, _this.coverageData[file]);
                }).join('\n');
            fs.writeFileSync(coverFile, coverage);
            console.info("Writing coverage information. OK!");
        }
    };
    return Bat;
}());
exports.Bat = Bat;
function generateMochaTest(test) {
    var execFn = test.skip
        ? describe.skip
        : describe;
    execFn(test.description || (test.method.toUpperCase() + ' ' + test.uri), function () {
        it(test.method.toUpperCase() + ' ' + test.uri, function (done) {
            test
                .requester
                .promise
                .then(function (response) {
                done();
            })
                .catch(function (err) {
                console.error(util.inspect(err));
                done(err);
            });
        });
        test.assertions.forEach(function (x) {
            it(x.name, function (done) {
                x.promise
                    .then(function (err) {
                    if (err) {
                        console.error(util.inspect(err));
                        done(err);
                    }
                    else
                        done();
                })
                    .catch(function (err) {
                    console.error(util.inspect(err));
                    done(err);
                });
            });
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmF0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPO0FBQ1AsSUFBTyxFQUFFLFdBQVcsSUFBSSxDQUFDLENBQUM7QUFDMUIsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFFOUIsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFFOUIsTUFBTTtBQUNOLElBQU8sTUFBTSxXQUFXLFNBQVMsQ0FBQyxDQUFDO0FBQ25DLElBQU8sQ0FBQyxXQUFXLFFBQVEsQ0FBQyxDQUFDO0FBQzdCLElBQU8sT0FBTyxXQUFXLFdBQVcsQ0FBQyxDQUFDO0FBSXRDLElBQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUN6QyxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUc3QyxTQUFTO0FBQ1QsSUFBTyxHQUFHLFdBQVcsT0FBTyxDQUFDLENBQUM7QUFDOUIsSUFBTyxVQUFVLFdBQVcsY0FBYyxDQUFDLENBQUM7QUFDNUMsSUFBTyxRQUFRLFdBQVcsWUFBWSxDQUFDLENBQUM7QUFDeEMscUNBQW1ELDZCQUE2QixDQUFDLENBQUE7QUFXakY7SUFlRSxhQUFtQixPQUF5QjtRQWY5QyxpQkF1V0M7UUF4VmEsdUJBQWdDLEdBQWhDLFlBQWdDO1FBQXpCLFlBQU8sR0FBUCxPQUFPLENBQWtCO1FBTDVDLGFBQVEsR0FBUSxRQUFRLENBQUM7UUFDekIsT0FBRSxHQUFRLEVBQUUsQ0FBQztRQUViLHFCQUFnQixHQUFnQyxFQUFFLENBQUM7UUFzVG5ELGlCQUFZLEdBRVAsRUFBRSxDQUFDO1FBclROLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFekIsSUFBSSxNQUFNLEdBQUcsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXRDLElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFD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Q2pDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDWixDQUFDO29CQUFDLElBQUk7d0JBQ0osSUFBSSxFQUFFLENBQUM7Z0JBQ1gsQ0FBQyxDQUFDO3FCQUNELEtBQUssQ0FBQyxVQUFBLEdBQUc7b0JBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ2pDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDWixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBOb2RlXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgdXJsID0gcmVxdWlyZSgndXJsJyk7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcblxuLy8gTlBNXG5pbXBvcnQganNZYW1sID0gcmVxdWlyZSgnanMteWFtbCcpO1xuaW1wb3J0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmltcG9ydCByZXF1ZXN0ID0gcmVxdWlyZSgnc3VwZXJ0ZXN0Jyk7XG5pbXBvcnQgc3VwZXJBZ2VudCA9IHJlcXVpcmUoJ3N1cGVyYWdlbnQnKTtcbmltcG9ydCBleHBlY3QgPSByZXF1aXJlKCdleHBlY3QnKTtcbmltcG9ydCBSQU1MID0gcmVxdWlyZSgncmFtbC0xLXBhcnNlcicpO1xuY29uc3QganNvbnNjaGVtYSA9IHJlcXVpcmUoJ2pzb25zY2hlbWEnKTtcbmNvbnN0IHBhdGhNYXRjaCA9IHJlcXVpcmUoJ3JhbWwtcGF0aC1tYXRjaCcpO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ3N1cGVyYWdlbnQnO1xuXG4vLyBMb2NhbHNcbmltcG9ydCBBVEwgPSByZXF1aXJlKCcuL0FUTCcpO1xuaW1wb3J0IEFUTEhlbHBlcnMgPSByZXF1aXJlKCcuL0FUTEhlbHBlcnMnKTtcbmltcG9ydCBDb3ZlcmFnZSA9IHJlcXVpcmUoJy4vQ292ZXJhZ2UnKTtcbmltcG9ydCB7IGdlbmVyYXRlU3RyaW5nIGFzIGNvdmVyYWdlVG9TdHJpbmcgfSBmcm9tICcuLi9saWIvUkFNTENvdmVyYWdlUmVwb3J0ZXInO1xuaW1wb3J0IHsgQVRMRXJyb3IsIEFUTFNraXBwZWQsIENvbW1vbkFzc2VydGlvbnMgfSBmcm9tICcuL0FUTEFzc2VydGlvbic7XG5cblxuZXhwb3J0IGludGVyZmFjZSBJQmF0T3B0aW9ucyB7XG4gIGJhc2VVcmk/OiBzdHJpbmc7XG4gIHZhcmlhYmxlcz86IEFUTEhlbHBlcnMuSURpY3Rpb25hcnk8YW55PjtcbiAgZmlsZT86IHN0cmluZztcbiAgcmF3Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgQmF0IHtcbiAgcGF0aDogc3RyaW5nO1xuICBmaWxlOiBzdHJpbmc7XG5cbiAgYXN0OiBBVEwuQVRMO1xuXG4gIHByaXZhdGUgX2xvYWRlZDogRnVuY3Rpb247XG4gIHByaXZhdGUgX2xvYWRlZEZhaWxlZDogRnVuY3Rpb247XG4gIGxvYWRlclNlbWFwaG9yZTogUHJvbWlzZTxhbnk+O1xuXG4gIGRlc2NyaWJlOiBhbnkgPSBkZXNjcmliZTtcbiAgaXQ6IGFueSA9IGl0O1xuXG4gIGNvdmVyYWdlRWxlbWVudHM6IENvdmVyYWdlLkNvdmVyYWdlUmVzb3VyY2VbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBvcHRpb25zOiBJQmF0T3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5hc3QgPSBuZXcgQVRMLkFUTCgpO1xuXG4gICAgbGV0IGdvdEFTVCA9IEFUTEhlbHBlcnMuZmxhdFByb21pc2UoKTtcblxuICAgIHRoaXMubG9hZGVyU2VtYXBob3JlID0gZ290QVNULnByb21pc2U7XG4gICAgdGhpcy5fbG9hZGVkID0gZ290QVNULnJlc29sdmVyO1xuICAgIHRoaXMuX2xvYWRlZEZhaWxlZCA9IGdvdEFTVC5yZWplY3RlcjtcblxuICAgIGlmIChvcHRpb25zLnJhdykge1xuICAgICAgdGhpcy5yYXcob3B0aW9ucy5yYXcpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5vcHRpb25zLmZpbGUpIHtcbiAgICAgIHRoaXMubG9hZChvcHRpb25zLmZpbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNoZWNrTW9jaGFDb250ZXh0KClcbiAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5ydW4oKSk7XG4gICAgfVxuICB9XG5cbiAgY2hlY2tNb2NoYUNvbnRleHQoKSB7XG5cbiAgICBsZXQgZ290Q29udGV4dCA9IEFUTEhlbHBlcnMuZmxhdFByb21pc2UoKTtcblxuICAgIHRoaXMuZGVzY3JpYmUoJ0NoZWNraW5nIG1vY2hhIGNvbnRleHQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBnb3RDb250ZXh0LnJlc29sdmVyKHRoaXMuY3R4KTtcbiAgICB9KTtcblxuICAgIC8vIGNoZWNrIGZvciBjb250ZXh0IGNvbmZpZ3VyYXRpb25zXG4gICAgcmV0dXJuIGdvdENvbnRleHQucHJvbWlzZS50aGVuKGN0eCA9PiB7XG4gICAgICBpZiAoY3R4KSB7XG4gICAgICAgIGN0eCA9IGN0eC5jb25maWcgfHwgY3R4O1xuXG4gICAgICAgIGlmIChjdHguYmF0RmlsZSkge1xuICAgICAgICAgIHRoaXMubG9hZChjdHguYmF0RmlsZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoY3R4LnJhd0JhdCkge1xuICAgICAgICAgIHRoaXMucmF3KGN0eC5yYXdCYXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGN0eC5iYXNlVXJpKSB7XG4gICAgICAgICAgdGhpcy5vcHRpb25zLmJhc2VVcmkgPSBjdHguYmFzZVVyaTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjdHgudmFyaWFibGVzKSB7XG4gICAgICAgICAgdGhpcy5vcHRpb25zLnZhcmlhYmxlcyA9IHRoaXMub3B0aW9ucy52YXJpYWJsZXMgfHwge307XG4gICAgICAgICAgXy5tZXJnZSh0aGlzLm9wdGlvbnMudmFyaWFibGVzLCBjdHgudmFyaWFibGVzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTdGF0ZSgpIHtcbiAgICBpZiAodGhpcy5vcHRpb25zLnZhcmlhYmxlcykge1xuICAgICAgXy5tZXJnZSh0aGlzLmFzdC5vcHRpb25zLnZhcmlhYmxlcywgdGhpcy5vcHRpb25zLnZhcmlhYmxlcyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0aW9ucy5iYXNlVXJpICYmIHRoaXMub3B0aW9ucy5iYXNlVXJpICE9ICdkZWZhdWx0Jykge1xuICAgICAgdGhpcy5hc3Qub3B0aW9ucy5iYXNlVXJpID0gdGhpcy5vcHRpb25zLmJhc2VVcmk7XG4gICAgfVxuICB9XG5cbiAgbG9hZChmaWxlOiBzdHJpbmcpIHtcbiAgICB0aGlzLnBhdGggPSBwYXRoLmRpcm5hbWUoZmlsZSk7XG4gICAgcHJvY2Vzcy5jaGRpcih0aGlzLnBhdGgpO1xuICAgIHRoaXMuZmlsZSA9IGZpbGU7XG5cbiAgICB0aGlzLnJhdyhmcy5yZWFkRmlsZVN5bmModGhpcy5maWxlLCAndXRmOCcpKTtcbiAgfVxuXG4gIHJhdyhjb250ZW50OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IHBhcnNlZCA9IGpzWWFtbC5sb2FkKGNvbnRlbnQsIHtcbiAgICAgICAgc2NoZW1hOiBBVExIZWxwZXJzLnBvaW50ZXJMaWIuY3JlYXRlU2NoZW1hKClcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmFzdC5vcHRpb25zLnBhdGggPSB0aGlzLnBhdGg7XG4gICAgICB0aGlzLmFzdC5mcm9tT2JqZWN0KHBhcnNlZCk7XG5cbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoKTtcblxuICAgICAgdGhpcy5fbG9hZGVkKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHRoaXMub3B0aW9ucy5maWxlKVxuICAgICAgICBlLm1lc3NhZ2UgPSB0aGlzLm9wdGlvbnMuZmlsZSArICdcXG4nICsgZS5tZXNzYWdlO1xuXG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIHJ1bihhcHA/KTogUHJvbWlzZTxCYXQ+IHtcbiAgICBsZXQgcHJvbSA9IEFUTEhlbHBlcnMuZmxhdFByb21pc2UoKTtcblxuICAgIHRoaXMuZGVzY3JpYmUodGhpcy5maWxlIHx8ICdodHRwLWJhdCcsICgpID0+IHtcbiAgICAgIGlmICh0aGlzLmFzdC5vcHRpb25zLnNlbGZTaWduZWRDZXJ0KSB7XG4gICAgICAgIHRoaXMuaXQoJ0FsbG93aW5nIHNlbGYgc2lnbmVkIHNlcnZlciBjZXJ0aWZpY2F0ZXMnLCBkb25lID0+IHtcbiAgICAgICAgICBwcm9jZXNzLmVudi5OT0RFX1RMU19SRUpFQ1RfVU5BVVRIT1JJWkVEID0gXCIwXCI7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuXG4gICAgICBpZiAodGhpcy5vcHRpb25zLmJhc2VVcmkgPT0gJ2RlZmF1bHQnKVxuICAgICAgICBkZWxldGUgdGhpcy5vcHRpb25zLmJhc2VVcmk7XG5cbiAgICAgIGlmICghYXBwIHx8IGFwcCA9PT0gXCJkZWZhdWx0XCIgfHwgYXBwID09PSAnJykge1xuICAgICAgICBhcHAgPSB0aGlzLm9wdGlvbnMuYmFzZVVyaSB8fCB0aGlzLmFzdC5vcHRpb25zLmJhc2VVcmk7XG4gICAgICB9XG5cbiAgICAgIGlmICghYXBwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImJhc2VVcmkgbm90IHNwZWNpZmllZFwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVvZiBhcHAgPT09ICdzdHJpbmcnICYmIGFwcC5zdWJzdHIoLTEpID09PSAnLycpIHtcbiAgICAgICAgYXBwID0gYXBwLnN1YnN0cigwLCBhcHAubGVuZ3RoIC0gMSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYXN0LmFnZW50ID0gcmVxdWVzdC5hZ2VudChhcHApO1xuXG4gICAgICAvLyBQYXJzZSB0aGUgcmFtbCBmb3IgY292ZXJhZ2VcbiAgICAgIGlmICh0aGlzLmFzdC5yYW1sKSB7XG4gICAgICAgIGxldCByZXNvdXJjZXMgPSB0aGlzLmFzdC5yYW1sLnJlc291cmNlcygpO1xuXG4gICAgICAgIGZvciAobGV0IHIgaW4gcmVzb3VyY2VzKSB7XG4gICAgICAgICAgdGhpcy5wZWVrUmVzb3VyY2UocmVzb3VyY2VzW3JdKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBSdW4gc3VpdGVzXG4gICAgICBmb3IgKGxldCBrIGluIHRoaXMuYXN0LnN1aXRlcykge1xuICAgICAgICBsZXQgc3VpdGUgPSB0aGlzLmFzdC5zdWl0ZXNba107XG5cbiAgICAgICAgdGhpcy5ydW5TdWl0ZShzdWl0ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZW5zdXJlUmFtbENvdmVyYWdlKCk7XG5cbiAgICAgIHRoaXMuZGVmZXJlZEl0KCdGaW5hbGl6ZSBBVEwgRG9jdW1lbnQnKS50aGVuKGRvbmUgPT4ge1xuICAgICAgICBwcm9tLnJlc29sdmVyKCk7XG5cbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcHJvbS5wcm9taXNlO1xuICB9XG5cbiAgcHJpdmF0ZSBlbnN1cmVSYW1sQ292ZXJhZ2UoKSB7XG4gICAgaWYgKHRoaXMuYXN0LnJhbWwpIHtcbiAgICAgIHRoaXMuZGVzY3JpYmUoXCJSQU1MIENvdmVyYWdlXCIsICgpID0+IHtcbiAgICAgICAgdGhpcy5pdCgnV2FpdCB0aGUgcmVzdWx0cyBiZWZvcmUgc3RhcnQnLCBkb25lID0+IHtcbiAgICAgICAgICBQcm9taXNlLmFsbCh0aGlzLmNvdmVyYWdlRWxlbWVudHMubWFwKGl0ZW0gPT4gaXRlbS5ydW4oKSkpXG4gICAgICAgICAgICAudGhlbigoKSA9PiBkb25lKCkpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IGRvbmUoZXJyKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLmFzdC5vcHRpb25zLnJhbWwuY292ZXJhZ2UpIHtcbiAgICAgICAgICB0aGlzLmNvdmVyYWdlRWxlbWVudHMuZm9yRWFjaCh4ID0+IHguaW5qZWN0TW9jaGFUZXN0cygpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGl0KCdQcmludCBjb3ZlcmFnZScsIChkb25lKSA9PiB7XG4gICAgICAgICAgUHJvbWlzZS5hbGwodGhpcy5jb3ZlcmFnZUVsZW1lbnRzLm1hcCh4ID0+IHguZ2V0Q292ZXJhZ2UoKSkpXG4gICAgICAgICAgICAudGhlbih4ID0+IHtcbiAgICAgICAgICAgICAgbGV0IHRvdGFsID0geC5yZWR1Y2UoKHByZXYsIGFjdHVhbCkgPT4ge1xuICAgICAgICAgICAgICAgIHByZXYuZXJyb3JlZCArPSBhY3R1YWwuZXJyb3JlZDtcbiAgICAgICAgICAgICAgICBwcmV2LnRvdGFsICs9IGFjdHVhbC50b3RhbDtcbiAgICAgICAgICAgICAgICBwcmV2Lm5vdENvdmVyZWQgKz0gYWN0dWFsLm5vdENvdmVyZWQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgICAgICAgICAgIH0sIHsgdG90YWw6IDAsIGVycm9yZWQ6IDAsIG5vdENvdmVyZWQ6IDAgfSk7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKHV0aWwuaW5zcGVjdCh0b3RhbCwgZmFsc2UsIDIsIHRydWUpKTtcbiAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwZWVrUmVzb3VyY2UocmVzb3VyY2U6IFJBTUwuYXBpMDguUmVzb3VyY2UgfCBSQU1MLmFwaTEwLlJlc291cmNlLCBwYXJlbnQ/OiBzdHJpbmcpIHtcbiAgICBsZXQgdGhpc1VybCA9IChwYXJlbnQgfHwgXCJcIikgKyByZXNvdXJjZS5yZWxhdGl2ZVVyaSgpLnZhbHVlKCk7XG5cbiAgICB0aGlzLmNvdmVyYWdlRWxlbWVudHMucHVzaChuZXcgQ292ZXJhZ2UuQ292ZXJhZ2VSZXNvdXJjZShyZXNvdXJjZSBhcyBhbnksIHRoaXMpKTtcblxuICAgIGxldCByZXNvdXJjZXMgPSByZXNvdXJjZS5yZXNvdXJjZXMoKTtcblxuICAgIGZvciAobGV0IHIgaW4gcmVzb3VyY2VzKSB7XG4gICAgICB0aGlzLnBlZWtSZXNvdXJjZShyZXNvdXJjZXNbcl0sIHRoaXNVcmwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJUZXN0UmVzdWx0KHRlc3Q6IEFUTEhlbHBlcnMuQVRMVGVzdCwgY3R4OiB7XG4gICAgcmVxOiBzdXBlckFnZW50LlN1cGVyQWdlbnRSZXF1ZXN0O1xuICAgIHJlczogcmVxdWVzdC5SZXNwb25zZTtcbiAgICB0ZXN0OiBBVExIZWxwZXJzLkFUTFRlc3Q7XG4gICAgdXJsOiBzdHJpbmc7XG4gIH0pIHtcbiAgICBsZXQga2V5ID0gQVRMSGVscGVycy5tYXRjaFVybCh0ZXN0LnVyaSk7XG5cbiAgICB0aGlzLmNvdmVyYWdlRWxlbWVudHMuZm9yRWFjaChjb3ZlcmFnZUVsZW1lbnQgPT4ge1xuICAgICAgaWYgKGNvdmVyYWdlRWxlbWVudC5tYXRjaGVzKGN0eC51cmwpKSB7XG4gICAgICAgIGNvdmVyYWdlRWxlbWVudC5yZXNvbHZlKGN0eC50ZXN0LCBjdHgucmVzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBydW5TdWl0ZShzdWl0ZTogQVRMSGVscGVycy5BVExTdWl0ZSk6IFByb21pc2U8YW55PiB7XG4gICAgbGV0IGV4ZWNGbiA9IHN1aXRlLnNraXAgPyB0aGlzLmRlc2NyaWJlLnNraXAgOiB0aGlzLmRlc2NyaWJlO1xuICAgIGxldCBwcm9taXNlcyA9IFtdO1xuXG4gICAgaWYgKHN1aXRlLnRlc3QpIHtcbiAgICAgIC8vIHRoaXMucnVuVGVzdChzdWl0ZS50ZXN0KTtcbiAgICAgIGxldCB0ZXN0UmVzdWx0ID0gc3VpdGUudGVzdC5ydW4oKTtcblxuICAgICAgcHJvbWlzZXMucHVzaCh0ZXN0UmVzdWx0KTtcblxuICAgICAgdGVzdFJlc3VsdC50aGVuKHJlcyA9PiB7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJUZXN0UmVzdWx0KHN1aXRlLnRlc3QsIHtcbiAgICAgICAgICByZXE6IHN1aXRlLnRlc3QucmVxdWVzdGVyLnN1cGVyQWdlbnRSZXF1ZXN0LFxuICAgICAgICAgIHJlczogc3VpdGUudGVzdC5yZXF1ZXN0ZXIuc3VwZXJBZ2VudFJlc3BvbnNlLFxuICAgICAgICAgIHRlc3Q6IHN1aXRlLnRlc3QsXG4gICAgICAgICAgdXJsOiBzdWl0ZS50ZXN0LnJlcXVlc3Rlci51cmxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgZ2VuZXJhdGVNb2NoYVRlc3Qoc3VpdGUudGVzdCk7XG4gICAgfVxuXG4gICAgbGV0IHRoYXQgPSB0aGlzO1xuXG4gICAgaWYgKHN1aXRlLnN1aXRlcyAmJiBPYmplY3Qua2V5cyhzdWl0ZS5zdWl0ZXMpLmxlbmd0aCkge1xuICAgICAgZXhlY0ZuKHN1aXRlLm5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZm9yIChsZXQgayBpbiBzdWl0ZS5zdWl0ZXMpIHtcbiAgICAgICAgICBsZXQgcyA9IHN1aXRlLnN1aXRlc1trXTtcbiAgICAgICAgICBwcm9taXNlcyA9IHByb21pc2VzLmNvbmNhdCh0aGF0LnJ1blN1aXRlKHMpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfVxuXG4gIG9idGFpblNjaGVtYVZhbGlkYXRvcihzY2hlbWE6IGFueSkge1xuICAgIGxldCB2ID0gbmV3IGpzb25zY2hlbWEuVmFsaWRhdG9yKCk7XG5cbiAgICBpZiAodHlwZW9mIHNjaGVtYSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICBpZiAoc2NoZW1hIGluIHRoaXMuYXN0LnNjaGVtYXMpIHtcbiAgICAgICAgdi5hZGRTY2hlbWEodGhpcy5hc3Quc2NoZW1hc1tzY2hlbWFdLCBzY2hlbWEpO1xuICAgICAgICBzY2hlbWEgPSB0aGlzLmFzdC5zY2hlbWFzW3NjaGVtYV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHNjaGVtYSA9IEpTT04ucGFyc2Uoc2NoZW1hKTtcbiAgICAgICAgICB2LmFkZFNjaGVtYShzY2hlbWEpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG5cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHNjaGVtYSA9PSBcIm9iamVjdFwiKSB7XG4gICAgICB2LmFkZFNjaGVtYShzY2hlbWEpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2NoZW1hICcgKyB1dGlsLmluc3BlY3Qoc2NoZW1hKSk7XG4gICAgfVxuXG4gICAgaWYgKHYudW5yZXNvbHZlZFJlZnMgJiYgdi51bnJlc29sdmVkUmVmcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZGVzY3JpYmUoXCJMb2FkIHJlZmVyZW5jZWQgc2NoZW1hc1wiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHdoaWxlICh2LnVucmVzb2x2ZWRSZWZzICYmIHYudW5yZXNvbHZlZFJlZnMubGVuZ3RoKSB7XG4gICAgICAgICAgbGV0IG5leHRTY2hlbWEgPSB2LnVucmVzb2x2ZWRSZWZzLnNoaWZ0KCk7XG4gICAgICAgICAgdGhpcy5pdChcImxvYWQgc2NoZW1hIFwiICsgbmV4dFNjaGVtYSwgKCkgPT4ge1xuICAgICAgICAgICAgbGV0IHRoZVNjaGVtYSA9IHRoaXMuYXN0LnNjaGVtYXNbbmV4dFNjaGVtYV07XG5cbiAgICAgICAgICAgIGlmICghdGhlU2NoZW1hKVxuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJzY2hlbWEgXCIgKyBuZXh0U2NoZW1hICsgXCIgbm90IGZvdW5kXCIpO1xuXG4gICAgICAgICAgICB2LmFkZFNjaGVtYSh0aGVTY2hlbWEsIG5leHRTY2hlbWEpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gKGNvbnRlbnQpID0+IHtcbiAgICAgIHJldHVybiB2LnZhbGlkYXRlKGNvbnRlbnQsIHNjaGVtYSk7XG4gICAgfTtcbiAgfVxuXG4gIGRlZmVyZWRJdChuYW1lOiBzdHJpbmcsIHRpbWVvdXQ/OiBudW1iZXIpOiBQcm9taXNlPChlcnI/KSA9PiB2b2lkPiB7XG4gICAgbGV0IGZpbGwgPSBudWxsO1xuXG4gICAgbGV0IHByb20gPSBBVExIZWxwZXJzLmZsYXRQcm9taXNlKCk7XG5cbiAgICB0aGlzLml0KG5hbWUsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICBpZiAodGltZW91dClcbiAgICAgICAgdGhpcy50aW1lb3V0KHRpbWVvdXQpO1xuXG4gICAgICBwcm9tLnJlc29sdmVyLmNhbGwodGhpcywgZnVuY3Rpb24gKHJldCkge1xuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICAgICAgaWYgKHJldCkge1xuICAgICAgICAgIGlmIChkb25lLmZhaWwpXG4gICAgICAgICAgICBkb25lLmZhaWwocmV0KTtcbiAgICAgICAgICBlbHNlXG4gICAgICAgICAgICBkb25lKHJldCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgcHJvbS5wcm9taXNlLmNhdGNoKGRvbmUpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb20ucHJvbWlzZTtcbiAgfVxuXG4gIGNvdmVyYWdlRGF0YTogQVRMSGVscGVycy5JRGljdGlvbmFyeTx7XG4gICAgc291cmNlOiBBcnJheTxudW1iZXIgfCB2b2lkPjtcbiAgfT4gPSB7fTtcblxuICB3cml0ZUNvdmVyYWdlKGNvdmVyRmlsZTogc3RyaW5nKSB7XG4gICAgbGV0IGN3ZCA9IHBhdGguZGlybmFtZShjb3ZlckZpbGUpO1xuXG4gICAgaWYgKHRoaXMuY292ZXJhZ2VEYXRhICYmIE9iamVjdC5rZXlzKHRoaXMuY292ZXJhZ2VEYXRhKS5sZW5ndGgpIHtcbiAgICAgIGNvbnNvbGUuaW5mbyhcIldyaXRpbmcgY292ZXJhZ2UgaW5mb3JtYXRpb246IFwiICsgY292ZXJGaWxlKTtcblxuICAgICAgbGV0IGNvdmVyYWdlID0gJyc7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGZzLm1rZGlyU3luYyhjd2QpO1xuICAgICAgfSBjYXRjaCAoZSkgeyB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvdmVyYWdlID0gZnMucmVhZEZpbGVTeW5jKGNvdmVyRmlsZSkudG9TdHJpbmcoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcblxuICAgICAgfVxuXG4gICAgICBpZiAoY292ZXJhZ2UubGVuZ3RoKSBjb3ZlcmFnZSA9IGNvdmVyYWdlICsgJ1xcbic7XG5cbiAgICAgIGNvdmVyYWdlID1cbiAgICAgICAgY292ZXJhZ2UgKz0gT2JqZWN0LmtleXModGhpcy5jb3ZlcmFnZURhdGEpXG4gICAgICAgICAgLmZpbHRlcih4ID0+ICEheClcbiAgICAgICAgICAubWFwKChmaWxlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gY292ZXJhZ2VUb1N0cmluZyhmaWxlLCB0aGlzLmNvdmVyYWdlRGF0YVtmaWxlXSBhcyBhbnkpO1xuICAgICAgICAgIH0pLmpvaW4oJ1xcbicpO1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGNvdmVyRmlsZSwgY292ZXJhZ2UpO1xuXG4gICAgICBjb25zb2xlLmluZm8oXCJXcml0aW5nIGNvdmVyYWdlIGluZm9ybWF0aW9uLiBPSyFcIik7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlTW9jaGFUZXN0KHRlc3Q6IEFUTEhlbHBlcnMuQVRMVGVzdCkge1xuXG4gIGxldCBleGVjRm4gPSB0ZXN0LnNraXBcbiAgICA/IGRlc2NyaWJlLnNraXBcbiAgICA6IGRlc2NyaWJlO1xuXG4gIGV4ZWNGbih0ZXN0LmRlc2NyaXB0aW9uIHx8ICh0ZXN0Lm1ldGhvZC50b1VwcGVyQ2FzZSgpICsgJyAnICsgdGVzdC51cmkpLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQodGVzdC5tZXRob2QudG9VcHBlckNhc2UoKSArICcgJyArIHRlc3QudXJpLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgdGVzdFxuICAgICAgICAucmVxdWVzdGVyXG4gICAgICAgIC5wcm9taXNlXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IodXRpbC5pbnNwZWN0KGVycikpO1xuICAgICAgICAgIGRvbmUoZXJyKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cblxuICAgIHRlc3QuYXNzZXJ0aW9ucy5mb3JFYWNoKHggPT4ge1xuICAgICAgaXQoeC5uYW1lLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICB4LnByb21pc2VcbiAgICAgICAgICAudGhlbihlcnIgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKHV0aWwuaW5zcGVjdChlcnIpKTtcbiAgICAgICAgICAgICAgZG9uZShlcnIpO1xuICAgICAgICAgICAgfSBlbHNlXG4gICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcih1dGlsLmluc3BlY3QoZXJyKSk7XG4gICAgICAgICAgICBkb25lKGVycik7XG4gICAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59Il19