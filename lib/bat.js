"use strict";
// Node
var fs = require('fs');
var path = require('path');
var util = require('util');
// NPM
// import jsYaml = require('js-yaml');
var _ = require('lodash');
var request = require('supertest');
var pathMatch = require('raml-path-match');
// Locals
var ATL = require('./ATL');
var ATLHelpers = require('./ATLHelpers');
var Coverage = require('./Coverage');
var RAMLCoverageReporter_1 = require('../lib/RAMLCoverageReporter');
var YAML = require('./YAML');
var Bat = (function () {
    function Bat(options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        this.options = options;
        this.coverageElements = [];
        this.coverageData = {};
        this.ast = new ATL.ATL();
        var gotAST = ATLHelpers.flatPromise();
        this.loaderSemaphore = gotAST.promise;
        this._loaded = gotAST.resolver;
        this._loadedFailed = gotAST.rejecter;
        if (options.raw) {
            this.raw(options.raw);
        }
        else if (this.options.file) {
            this.load(options.file);
        }
        else {
            this.checkMochaContext()
                .then(function () { return _this.run(); });
        }
    }
    Bat.prototype.checkMochaContext = function () {
        var _this = this;
        var gotContext = ATLHelpers.flatPromise();
        describe('Checking mocha context', function () {
            gotContext.resolver(this.ctx);
        });
        // check for context configurations
        return gotContext.promise.then(function (ctx) {
            if (ctx) {
                ctx = ctx.config || ctx;
                if (ctx.batFile) {
                    _this.load(ctx.batFile);
                }
                else if (ctx.rawBat) {
                    _this.raw(ctx.rawBat);
                }
                if (ctx.baseUri) {
                    _this.options.baseUri = ctx.baseUri;
                }
                if (ctx.variables) {
                    _this.options.variables = _this.options.variables || {};
                    _.merge(_this.options.variables, ctx.variables);
                }
            }
        });
    };
    Bat.prototype.updateState = function () {
        if (this.options.variables) {
            _.merge(this.ast.options.variables, this.options.variables);
        }
        if (this.options.baseUri && this.options.baseUri != 'default') {
            this.ast.options.baseUri = this.options.baseUri;
        }
    };
    Bat.prototype.load = function (file) {
        this.path = path.dirname(file);
        process.chdir(this.path);
        this.file = file;
        this.raw(fs.readFileSync(this.file, 'utf8'));
    };
    Bat.prototype.raw = function (content) {
        try {
            var parsed = YAML.load(content);
            console.log(util.inspect(parsed, false, 5, true));
            this.ast.options.path = this.path;
            this.ast.fromObject(parsed);
            this.updateState();
            this._loaded();
            // Parse the raml for coverage
            if (this.ast.raml) {
                var resources = this.ast.raml.resources();
                for (var r in resources) {
                    this.peekResource(resources[r]);
                }
            }
        }
        catch (e) {
            if (this.options.file)
                e.message = this.options.file + '\n' + e.message;
            throw e;
        }
    };
    Bat.prototype.run = function (app) {
        var _this = this;
        var prom = ATLHelpers.flatPromise();
        try {
            if (this.ast.options.selfSignedCert) {
                process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
            }
            if (this.options.baseUri == 'default')
                delete this.options.baseUri;
            if (!app || app === "default" || app === '') {
                app = this.options.baseUri || this.ast.options.baseUri;
            }
            if (!app) {
                throw new Error("baseUri not specified");
            }
            if (typeof app === 'string' && app.substr(-1) === '/') {
                app = app.substr(0, app.length - 1);
            }
            this.ast.agent = request.agent(app);
            // Run tests
            var tests = this.allTests();
            var allDone_1 = [];
            tests.forEach(function (test) {
                var testResult = test.run();
                allDone_1.push(testResult
                    .then(function (result) { return Promise.resolve({
                    response: result,
                    success: true
                }); })
                    .catch(function (result) { return Promise.resolve({
                    response: result,
                    success: false
                }); }));
                testResult.then(function (res) {
                    _this.registerTestResult(test, {
                        req: test.requester.superAgentRequest,
                        res: test.requester.superAgentResponse,
                        test: test,
                        url: test.requester.url
                    });
                });
            });
            Promise.all(allDone_1).then(function () { return prom.resolver(); });
        }
        catch (e) {
            prom.rejecter(e);
        }
        return prom.promise;
    };
    Bat.prototype.peekResource = function (resource, parent) {
        var thisUrl = (parent || "") + resource.relativeUri().value();
        this.coverageElements.push(new Coverage.CoverageResource(resource, this));
        var resources = resource.resources();
        for (var r in resources) {
            this.peekResource(resources[r], thisUrl);
        }
    };
    Bat.prototype.registerTestResult = function (test, ctx) {
        var key = ATLHelpers.matchUrl(test.uri);
        this.coverageElements.forEach(function (coverageElement) {
            if (coverageElement.matches(ctx.url)) {
                coverageElement.resolve(ctx.test, ctx.res);
            }
        });
    };
    Bat.prototype.allTests = function () {
        var tests = [];
        var walk = function (suite) {
            if (suite.test)
                tests.push(suite.test);
            if (suite.suites && Object.keys(suite.suites).length) {
                for (var k in suite.suites)
                    walk(suite.suites[k]);
            }
        };
        for (var suite_1 in this.ast.suites)
            walk(this.ast.suites[suite_1]);
        return tests;
    };
    Bat.prototype.writeCoverage = function (coverFile) {
        var _this = this;
        var cwd = path.dirname(coverFile);
        if (this.coverageData && Object.keys(this.coverageData).length) {
            console.info("Writing coverage information: " + coverFile);
            var coverage = '';
            try {
                fs.mkdirSync(cwd);
            }
            catch (e) { }
            try {
                coverage = fs.readFileSync(coverFile).toString();
            }
            catch (e) {
            }
            if (coverage.length)
                coverage = coverage + '\n';
            coverage =
                coverage += Object.keys(this.coverageData)
                    .filter(function (x) { return !!x; })
                    .map(function (file) {
                    return RAMLCoverageReporter_1.generateString(file, _this.coverageData[file]);
                }).join('\n');
            fs.writeFileSync(coverFile, coverage);
            console.info("Writing coverage information. OK!");
        }
    };
    return Bat;
}());
exports.Bat = Bat;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmF0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPO0FBQ1AsSUFBTyxFQUFFLFdBQVcsSUFBSSxDQUFDLENBQUM7QUFDMUIsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFFOUIsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFFOUIsTUFBTTtBQUNOLHNDQUFzQztBQUN0QyxJQUFPLENBQUMsV0FBVyxRQUFRLENBQUMsQ0FBQztBQUM3QixJQUFPLE9BQU8sV0FBVyxXQUFXLENBQUMsQ0FBQztBQUl0QyxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUk3QyxTQUFTO0FBQ1QsSUFBTyxHQUFHLFdBQVcsT0FBTyxDQUFDLENBQUM7QUFDOUIsSUFBTyxVQUFVLFdBQVcsY0FBYyxDQUFDLENBQUM7QUFDNUMsSUFBTyxRQUFRLFdBQVcsWUFBWSxDQUFDLENBQUM7QUFDeEMscUNBQW1ELDZCQUE2QixDQUFDLENBQUE7QUFFakYsSUFBTyxJQUFJLFdBQVcsUUFBUSxDQUFDLENBQUM7QUFTaEM7SUFZRSxhQUFtQixPQUF5QjtRQVo5QyxpQkE4UEM7UUFsUGEsdUJBQWdDLEdBQWhDLFlBQWdDO1FBQXpCLFlBQU8sR0FBUCxPQUFPLENBQWtCO1FBRjVDLHFCQUFnQixHQUFnQyxFQUFFLENBQUM7UUFnTm5ELGlCQUFZLEdBRVAsRUFBRSxDQUFDO1FBL01OLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFekIsSUFBSSxNQUFNLEdBQUcsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXRDLElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUN0QyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDL0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxN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Ly8gTm9kZVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHVybCA9IHJlcXVpcmUoJ3VybCcpO1xuaW1wb3J0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5cbi8vIE5QTVxuLy8gaW1wb3J0IGpzWWFtbCA9IHJlcXVpcmUoJ2pzLXlhbWwnKTtcbmltcG9ydCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5pbXBvcnQgcmVxdWVzdCA9IHJlcXVpcmUoJ3N1cGVydGVzdCcpO1xuaW1wb3J0IHN1cGVyQWdlbnQgPSByZXF1aXJlKCdzdXBlcmFnZW50Jyk7XG5pbXBvcnQgZXhwZWN0ID0gcmVxdWlyZSgnZXhwZWN0Jyk7XG5pbXBvcnQgUkFNTCA9IHJlcXVpcmUoJ3JhbWwtMS1wYXJzZXInKTtcbmNvbnN0IHBhdGhNYXRjaCA9IHJlcXVpcmUoJ3JhbWwtcGF0aC1tYXRjaCcpO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ3N1cGVyYWdlbnQnO1xuXG5cbi8vIExvY2Fsc1xuaW1wb3J0IEFUTCA9IHJlcXVpcmUoJy4vQVRMJyk7XG5pbXBvcnQgQVRMSGVscGVycyA9IHJlcXVpcmUoJy4vQVRMSGVscGVycycpO1xuaW1wb3J0IENvdmVyYWdlID0gcmVxdWlyZSgnLi9Db3ZlcmFnZScpO1xuaW1wb3J0IHsgZ2VuZXJhdGVTdHJpbmcgYXMgY292ZXJhZ2VUb1N0cmluZyB9IGZyb20gJy4uL2xpYi9SQU1MQ292ZXJhZ2VSZXBvcnRlcic7XG5pbXBvcnQgeyBBVExFcnJvciwgQVRMU2tpcHBlZCwgQ29tbW9uQXNzZXJ0aW9ucyB9IGZyb20gJy4vQVRMQXNzZXJ0aW9uJztcbmltcG9ydCBZQU1MID0gcmVxdWlyZSgnLi9ZQU1MJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUJhdE9wdGlvbnMge1xuICBiYXNlVXJpPzogc3RyaW5nO1xuICB2YXJpYWJsZXM/OiBBVExIZWxwZXJzLklEaWN0aW9uYXJ5PGFueT47XG4gIGZpbGU/OiBzdHJpbmc7XG4gIHJhdz86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEJhdCB7XG4gIHBhdGg6IHN0cmluZztcbiAgZmlsZTogc3RyaW5nO1xuXG4gIGFzdDogQVRMLkFUTDtcblxuICBwcml2YXRlIF9sb2FkZWQ6IEZ1bmN0aW9uO1xuICBwcml2YXRlIF9sb2FkZWRGYWlsZWQ6IEZ1bmN0aW9uO1xuICBsb2FkZXJTZW1hcGhvcmU6IFByb21pc2U8YW55PjtcblxuICBjb3ZlcmFnZUVsZW1lbnRzOiBDb3ZlcmFnZS5Db3ZlcmFnZVJlc291cmNlW10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgb3B0aW9uczogSUJhdE9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuYXN0ID0gbmV3IEFUTC5BVEwoKTtcblxuICAgIGxldCBnb3RBU1QgPSBBVExIZWxwZXJzLmZsYXRQcm9taXNlKCk7XG5cbiAgICB0aGlzLmxvYWRlclNlbWFwaG9yZSA9IGdvdEFTVC5wcm9taXNlO1xuICAgIHRoaXMuX2xvYWRlZCA9IGdvdEFTVC5yZXNvbHZlcjtcbiAgICB0aGlzLl9sb2FkZWRGYWlsZWQgPSBnb3RBU1QucmVqZWN0ZXI7XG5cbiAgICBpZiAob3B0aW9ucy5yYXcpIHtcbiAgICAgIHRoaXMucmF3KG9wdGlvbnMucmF3KTtcbiAgICB9IGVsc2UgaWYgKHRoaXMub3B0aW9ucy5maWxlKSB7XG4gICAgICB0aGlzLmxvYWQob3B0aW9ucy5maWxlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jaGVja01vY2hhQ29udGV4dCgpXG4gICAgICAgIC50aGVuKCgpID0+IHRoaXMucnVuKCkpO1xuICAgIH1cbiAgfVxuXG4gIGNoZWNrTW9jaGFDb250ZXh0KCkge1xuXG4gICAgbGV0IGdvdENvbnRleHQgPSBBVExIZWxwZXJzLmZsYXRQcm9taXNlKCk7XG5cbiAgICBkZXNjcmliZSgnQ2hlY2tpbmcgbW9jaGEgY29udGV4dCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGdvdENvbnRleHQucmVzb2x2ZXIodGhpcy5jdHgpO1xuICAgIH0pO1xuXG4gICAgLy8gY2hlY2sgZm9yIGNvbnRleHQgY29uZmlndXJhdGlvbnNcbiAgICByZXR1cm4gZ290Q29udGV4dC5wcm9taXNlLnRoZW4oY3R4ID0+IHtcbiAgICAgIGlmIChjdHgpIHtcbiAgICAgICAgY3R4ID0gY3R4LmNvbmZpZyB8fCBjdHg7XG5cbiAgICAgICAgaWYgKGN0eC5iYXRGaWxlKSB7XG4gICAgICAgICAgdGhpcy5sb2FkKGN0eC5iYXRGaWxlKTtcbiAgICAgICAgfSBlbHNlIGlmIChjdHgucmF3QmF0KSB7XG4gICAgICAgICAgdGhpcy5yYXcoY3R4LnJhd0JhdCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY3R4LmJhc2VVcmkpIHtcbiAgICAgICAgICB0aGlzLm9wdGlvbnMuYmFzZVVyaSA9IGN0eC5iYXNlVXJpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGN0eC52YXJpYWJsZXMpIHtcbiAgICAgICAgICB0aGlzLm9wdGlvbnMudmFyaWFibGVzID0gdGhpcy5vcHRpb25zLnZhcmlhYmxlcyB8fCB7fTtcbiAgICAgICAgICBfLm1lcmdlKHRoaXMub3B0aW9ucy52YXJpYWJsZXMsIGN0eC52YXJpYWJsZXMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVN0YXRlKCkge1xuICAgIGlmICh0aGlzLm9wdGlvbnMudmFyaWFibGVzKSB7XG4gICAgICBfLm1lcmdlKHRoaXMuYXN0Lm9wdGlvbnMudmFyaWFibGVzLCB0aGlzLm9wdGlvbnMudmFyaWFibGVzKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRpb25zLmJhc2VVcmkgJiYgdGhpcy5vcHRpb25zLmJhc2VVcmkgIT0gJ2RlZmF1bHQnKSB7XG4gICAgICB0aGlzLmFzdC5vcHRpb25zLmJhc2VVcmkgPSB0aGlzLm9wdGlvbnMuYmFzZVVyaTtcbiAgICB9XG4gIH1cblxuICBsb2FkKGZpbGU6IHN0cmluZykge1xuICAgIHRoaXMucGF0aCA9IHBhdGguZGlybmFtZShmaWxlKTtcbiAgICBwcm9jZXNzLmNoZGlyKHRoaXMucGF0aCk7XG4gICAgdGhpcy5maWxlID0gZmlsZTtcblxuICAgIHRoaXMucmF3KGZzLnJlYWRGaWxlU3luYyh0aGlzLmZpbGUsICd1dGY4JykpO1xuICB9XG5cbiAgcmF3KGNvbnRlbnQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBsZXQgcGFyc2VkID0gWUFNTC5sb2FkKGNvbnRlbnQpO1xuXG4gICAgICBjb25zb2xlLmxvZyh1dGlsLmluc3BlY3QocGFyc2VkLCBmYWxzZSwgNSwgdHJ1ZSkpO1xuXG4gICAgICB0aGlzLmFzdC5vcHRpb25zLnBhdGggPSB0aGlzLnBhdGg7XG4gICAgICB0aGlzLmFzdC5mcm9tT2JqZWN0KHBhcnNlZCk7XG5cbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoKTtcblxuICAgICAgdGhpcy5fbG9hZGVkKCk7XG5cbiAgICAgIC8vIFBhcnNlIHRoZSByYW1sIGZvciBjb3ZlcmFnZVxuICAgICAgaWYgKHRoaXMuYXN0LnJhbWwpIHtcbiAgICAgICAgbGV0IHJlc291cmNlcyA9IHRoaXMuYXN0LnJhbWwucmVzb3VyY2VzKCk7XG5cbiAgICAgICAgZm9yIChsZXQgciBpbiByZXNvdXJjZXMpIHtcbiAgICAgICAgICB0aGlzLnBlZWtSZXNvdXJjZShyZXNvdXJjZXNbcl0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHRoaXMub3B0aW9ucy5maWxlKVxuICAgICAgICBlLm1lc3NhZ2UgPSB0aGlzLm9wdGlvbnMuZmlsZSArICdcXG4nICsgZS5tZXNzYWdlO1xuXG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIHJ1bihhcHA/KTogUHJvbWlzZTxCYXQ+IHtcbiAgICBsZXQgcHJvbSA9IEFUTEhlbHBlcnMuZmxhdFByb21pc2UoKTtcblxuICAgIHRyeSB7XG4gICAgICBpZiAodGhpcy5hc3Qub3B0aW9ucy5zZWxmU2lnbmVkQ2VydCkge1xuICAgICAgICBwcm9jZXNzLmVudi5OT0RFX1RMU19SRUpFQ1RfVU5BVVRIT1JJWkVEID0gXCIwXCI7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuYmFzZVVyaSA9PSAnZGVmYXVsdCcpXG4gICAgICAgIGRlbGV0ZSB0aGlzLm9wdGlvbnMuYmFzZVVyaTtcblxuICAgICAgaWYgKCFhcHAgfHwgYXBwID09PSBcImRlZmF1bHRcIiB8fCBhcHAgPT09ICcnKSB7XG4gICAgICAgIGFwcCA9IHRoaXMub3B0aW9ucy5iYXNlVXJpIHx8IHRoaXMuYXN0Lm9wdGlvbnMuYmFzZVVyaTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFhcHApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYmFzZVVyaSBub3Qgc3BlY2lmaWVkXCIpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIGFwcCA9PT0gJ3N0cmluZycgJiYgYXBwLnN1YnN0cigtMSkgPT09ICcvJykge1xuICAgICAgICBhcHAgPSBhcHAuc3Vic3RyKDAsIGFwcC5sZW5ndGggLSAxKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5hc3QuYWdlbnQgPSByZXF1ZXN0LmFnZW50KGFwcCk7XG5cbiAgICAgIC8vIFJ1biB0ZXN0c1xuXG4gICAgICBsZXQgdGVzdHMgPSB0aGlzLmFsbFRlc3RzKCk7XG4gICAgICBsZXQgYWxsRG9uZSA9IFtdO1xuXG4gICAgICB0ZXN0cy5mb3JFYWNoKHRlc3QgPT4ge1xuICAgICAgICBsZXQgdGVzdFJlc3VsdCA9IHRlc3QucnVuKCk7XG5cbiAgICAgICAgYWxsRG9uZS5wdXNoKFxuICAgICAgICAgIHRlc3RSZXN1bHRcbiAgICAgICAgICAgIC50aGVuKHJlc3VsdCA9PiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgICAgICByZXNwb25zZTogcmVzdWx0LFxuICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgICAgIC5jYXRjaChyZXN1bHQgPT4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgICAgICAgcmVzcG9uc2U6IHJlc3VsdCxcbiAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2VcbiAgICAgICAgICAgIH0pKVxuICAgICAgICApO1xuXG4gICAgICAgIHRlc3RSZXN1bHQudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHRoaXMucmVnaXN0ZXJUZXN0UmVzdWx0KHRlc3QsIHtcbiAgICAgICAgICAgIHJlcTogdGVzdC5yZXF1ZXN0ZXIuc3VwZXJBZ2VudFJlcXVlc3QsXG4gICAgICAgICAgICByZXM6IHRlc3QucmVxdWVzdGVyLnN1cGVyQWdlbnRSZXNwb25zZSxcbiAgICAgICAgICAgIHRlc3Q6IHRlc3QsXG4gICAgICAgICAgICB1cmw6IHRlc3QucmVxdWVzdGVyLnVybFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBQcm9taXNlLmFsbChhbGxEb25lKS50aGVuKCgpID0+IHByb20ucmVzb2x2ZXIoKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcHJvbS5yZWplY3RlcihlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvbS5wcm9taXNlO1xuICB9XG5cbiAgcHJpdmF0ZSBwZWVrUmVzb3VyY2UocmVzb3VyY2U6IFJBTUwuYXBpMDguUmVzb3VyY2UgfCBSQU1MLmFwaTEwLlJlc291cmNlLCBwYXJlbnQ/OiBzdHJpbmcpIHtcbiAgICBsZXQgdGhpc1VybCA9IChwYXJlbnQgfHwgXCJcIikgKyByZXNvdXJjZS5yZWxhdGl2ZVVyaSgpLnZhbHVlKCk7XG5cbiAgICB0aGlzLmNvdmVyYWdlRWxlbWVudHMucHVzaChuZXcgQ292ZXJhZ2UuQ292ZXJhZ2VSZXNvdXJjZShyZXNvdXJjZSBhcyBhbnksIHRoaXMpKTtcblxuICAgIGxldCByZXNvdXJjZXMgPSByZXNvdXJjZS5yZXNvdXJjZXMoKTtcblxuICAgIGZvciAobGV0IHIgaW4gcmVzb3VyY2VzKSB7XG4gICAgICB0aGlzLnBlZWtSZXNvdXJjZShyZXNvdXJjZXNbcl0sIHRoaXNVcmwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJUZXN0UmVzdWx0KHRlc3Q6IEFUTEhlbHBlcnMuQVRMVGVzdCwgY3R4OiB7XG4gICAgcmVxOiBzdXBlckFnZW50LlN1cGVyQWdlbnRSZXF1ZXN0O1xuICAgIHJlczogc3VwZXJBZ2VudC5SZXNwb25zZTtcbiAgICB0ZXN0OiBBVExIZWxwZXJzLkFUTFRlc3Q7XG4gICAgdXJsOiBzdHJpbmc7XG4gIH0pIHtcbiAgICBsZXQga2V5ID0gQVRMSGVscGVycy5tYXRjaFVybCh0ZXN0LnVyaSk7XG5cbiAgICB0aGlzLmNvdmVyYWdlRWxlbWVudHMuZm9yRWFjaChjb3ZlcmFnZUVsZW1lbnQgPT4ge1xuICAgICAgaWYgKGNvdmVyYWdlRWxlbWVudC5tYXRjaGVzKGN0eC51cmwpKSB7XG4gICAgICAgIGNvdmVyYWdlRWxlbWVudC5yZXNvbHZlKGN0eC50ZXN0LCBjdHgucmVzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFsbFRlc3RzKCk6IEFUTEhlbHBlcnMuQVRMVGVzdFtdIHtcbiAgICBsZXQgdGVzdHMgPSBbXTtcblxuICAgIGNvbnN0IHdhbGsgPSAoc3VpdGU6IEFUTEhlbHBlcnMuQVRMU3VpdGUpID0+IHtcbiAgICAgIGlmIChzdWl0ZS50ZXN0KVxuICAgICAgICB0ZXN0cy5wdXNoKHN1aXRlLnRlc3QpO1xuXG4gICAgICBpZiAoc3VpdGUuc3VpdGVzICYmIE9iamVjdC5rZXlzKHN1aXRlLnN1aXRlcykubGVuZ3RoKSB7XG4gICAgICAgIGZvciAobGV0IGsgaW4gc3VpdGUuc3VpdGVzKVxuICAgICAgICAgIHdhbGsoc3VpdGUuc3VpdGVzW2tdKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgZm9yIChsZXQgc3VpdGUgaW4gdGhpcy5hc3Quc3VpdGVzKVxuICAgICAgd2Fsayh0aGlzLmFzdC5zdWl0ZXNbc3VpdGVdKTtcblxuICAgIHJldHVybiB0ZXN0cztcbiAgfVxuXG4gIGNvdmVyYWdlRGF0YTogQVRMSGVscGVycy5JRGljdGlvbmFyeTx7XG4gICAgc291cmNlOiBBcnJheTxudW1iZXIgfCB2b2lkPjtcbiAgfT4gPSB7fTtcblxuICB3cml0ZUNvdmVyYWdlKGNvdmVyRmlsZTogc3RyaW5nKSB7XG4gICAgbGV0IGN3ZCA9IHBhdGguZGlybmFtZShjb3ZlckZpbGUpO1xuXG4gICAgaWYgKHRoaXMuY292ZXJhZ2VEYXRhICYmIE9iamVjdC5rZXlzKHRoaXMuY292ZXJhZ2VEYXRhKS5sZW5ndGgpIHtcbiAgICAgIGNvbnNvbGUuaW5mbyhcIldyaXRpbmcgY292ZXJhZ2UgaW5mb3JtYXRpb246IFwiICsgY292ZXJGaWxlKTtcblxuICAgICAgbGV0IGNvdmVyYWdlID0gJyc7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGZzLm1rZGlyU3luYyhjd2QpO1xuICAgICAgfSBjYXRjaCAoZSkgeyB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvdmVyYWdlID0gZnMucmVhZEZpbGVTeW5jKGNvdmVyRmlsZSkudG9TdHJpbmcoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcblxuICAgICAgfVxuXG4gICAgICBpZiAoY292ZXJhZ2UubGVuZ3RoKSBjb3ZlcmFnZSA9IGNvdmVyYWdlICsgJ1xcbic7XG5cbiAgICAgIGNvdmVyYWdlID1cbiAgICAgICAgY292ZXJhZ2UgKz0gT2JqZWN0LmtleXModGhpcy5jb3ZlcmFnZURhdGEpXG4gICAgICAgICAgLmZpbHRlcih4ID0+ICEheClcbiAgICAgICAgICAubWFwKChmaWxlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gY292ZXJhZ2VUb1N0cmluZyhmaWxlLCB0aGlzLmNvdmVyYWdlRGF0YVtmaWxlXSBhcyBhbnkpO1xuICAgICAgICAgIH0pLmpvaW4oJ1xcbicpO1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGNvdmVyRmlsZSwgY292ZXJhZ2UpO1xuXG4gICAgICBjb25zb2xlLmluZm8oXCJXcml0aW5nIGNvdmVyYWdlIGluZm9ybWF0aW9uLiBPSyFcIik7XG4gICAgfVxuICB9XG59Il19