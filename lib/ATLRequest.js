"use strict";
// NODE
var util_1 = require('util');
var url = require('url');
var path = require('path');
// LOCAL
var ATLHelpers_1 = require('./ATLHelpers');
var Pointer_1 = require('./Pointer');
var ATLRequest = (function () {
    function ATLRequest(test) {
        this.test = test;
        this.flatPromise = ATLHelpers_1.flatPromise();
        this.promise = this.flatPromise.promise;
    }
    ATLRequest.prototype.run = function () {
        try {
            this._run();
        }
        catch (e) {
            this.flatPromise.rejecter(e);
        }
        return this.promise;
    };
    ATLRequest.prototype._run = function () {
        var _this = this;
        this.urlObject = url.parse(this.test.uri, true);
        this.urlObject.query = this.urlObject.query || {};
        if (this.test.request.queryParameters) {
            if ('search' in this.urlObject)
                delete this.urlObject.search;
            var qsParams = ATLHelpers_1.cloneObjectUsingPointers(this.test.request.queryParameters, this.test.suite.ATL.options.variables);
            for (var i in qsParams) {
                var typeOfValue = typeof qsParams[i];
                if (typeOfValue == 'undefined')
                    continue;
                if (typeOfValue != 'string' && typeOfValue != 'number') {
                    throw new Error("Only strings and numbers are allowed on queryParameters. " + i + "=" + util_1.inspect(qsParams[i]));
                }
                this.urlObject.query[i] = qsParams[i];
            }
        }
        var _loop_1 = function(i) {
            var value = null;
            if (this_1.test.uriParameters[i] instanceof Pointer_1.Pointer) {
                value = this_1.test.uriParameters[i].get(this_1.test.suite.ATL.options.variables);
            }
            else {
                value = this_1.test.uriParameters[i];
            }
            var typeOfValue = typeof value;
            if (typeOfValue != 'string' && typeOfValue != 'number') {
                throw new Error("Only strings and numbers are allowed on uriParameters. " + i + "=" + util_1.inspect(value));
            }
            this_1.urlObject.pathname = this_1.urlObject.pathname.replace(new RegExp("{" + i + "}", "g"), function (fulltext, match) {
                return encodeURIComponent(value);
            });
        };
        var this_1 = this;
        for (var i in this.test.uriParameters) {
            _loop_1(i);
        }
        this.url = url.format(this.urlObject);
        var req = this.superAgentRequest = this.test.suite.ATL.agent[this.test.method.toLowerCase()](this.url);
        // we must send some data..
        if (this.test.request) {
            if (this.test.request.headers) {
                var headers = ATLHelpers_1.cloneObjectUsingPointers(this.test.request.headers, this.test.suite.ATL.options.variables);
                for (var h in headers) {
                    req.set(h, headers[h] == undefined ? '' : headers[h].toString());
                }
            }
            if (this.test.request.json) {
                var data = ATLHelpers_1.cloneObjectUsingPointers(this.test.request.json, this.test.suite.ATL.options.variables);
                //          requestHolder.ctx.REQUEST.body = data;
                req.send(data);
            }
            if (this.test.request.attach) {
                /* istanbul ignore if */
                if (!this.test.suite.ATL.options.path) {
                    throw new Error("attach is not allowed using RAW definitions");
                }
                for (var i in this.test.request.attach) {
                    var currentAttachment = this.test.request.attach[i];
                    req.attach(currentAttachment.key, path.resolve(this.test.suite.ATL.options.path, currentAttachment.value));
                }
            }
            if (this.test.request.form) {
                req.type('form');
                for (var i in this.test.request.form) {
                    var currentAttachment = ATLHelpers_1.cloneObjectUsingPointers(this.test.request.form[i], this.test.suite.ATL.options.variables);
                    req.field(currentAttachment.key, currentAttachment.value);
                }
            }
            if (this.test.request.urlencoded) {
                req.send(ATLHelpers_1.cloneObjectUsingPointers(this.test.request.urlencoded, this.test.suite.ATL.options.variables));
            }
        }
        req.end(function (err, res) {
            _this.superAgentResponse = res;
            if (err) {
                return _this.flatPromise.rejecter(err);
            }
            return _this.flatPromise.resolver(res);
        });
    };
    ATLRequest.prototype.dependencyFailed = function () {
        this.flatPromise.rejecter(new Error('Dependency failed, skipping request.'));
    };
    return ATLRequest;
}());
exports.ATLRequest = ATLRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQVRMUmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFUTFJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU87QUFDUCxxQkFBd0IsTUFBTSxDQUFDLENBQUE7QUFDL0IsSUFBTyxHQUFHLFdBQVcsS0FBSyxDQUFDLENBQUM7QUFDNUIsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFLOUIsUUFBUTtBQUNSLDJCQUErRCxjQUFjLENBQUMsQ0FBQTtBQUM5RSx3QkFBd0IsV0FBVyxDQUFDLENBQUE7QUFFcEM7SUFXRSxvQkFBbUIsSUFBYTtRQUFiLFNBQUksR0FBSixJQUFJLENBQVM7UUFKeEIsZ0JBQVcsR0FBRyx3QkFBVyxFQUFFLENBQUM7UUFFcEMsWUFBTyxHQUFzQixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztJQUl0RCxDQUFDO0lBRUQsd0JBQUcsR0FBSDtRQUNFLElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNkLENBQUU7UUFBQSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1gsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFTyx5QkFBSSxHQUFaO1FBQUEsaUJBeUdDO1FBeEdDLElBQUksQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUM7UUFFbEQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FB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LENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxHQUFHLENBQUMsSUFBSSxDQUFDLHFDQUF3QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDMUcsQ0FBQztRQUdILENBQUM7UUFHRCxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQUMsR0FBRyxFQUFFLEdBQUc7WUFDZixLQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO1lBRTlCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ1IsTUFBTSxDQUFDLEtBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hDLENBQUM7WUFFRCxNQUFNLENBQUMsS0FBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQscUNBQWdCLEdBQWhCO1FBQ0UsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsc0NBQXNDLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFDSCxpQkFBQztBQUFELENBQUMsQUF0SUQsSUFzSUM7QUF0SVksa0JBQVUsYUFzSXRCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBOT0RFXG5pbXBvcnQgeyBpbnNwZWN0IH0gZnJvbSAndXRpbCc7XG5pbXBvcnQgdXJsID0gcmVxdWlyZSgndXJsJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuLy8gTlBNXG5pbXBvcnQgeyBSZXNwb25zZSwgU3VwZXJBZ2VudFJlcXVlc3QgfSBmcm9tICdzdXBlcmFnZW50JztcblxuLy8gTE9DQUxcbmltcG9ydCB7IEFUTFRlc3QsIGNsb25lT2JqZWN0VXNpbmdQb2ludGVycywgZmxhdFByb21pc2UgfSBmcm9tICcuL0FUTEhlbHBlcnMnO1xuaW1wb3J0IHsgUG9pbnRlciB9IGZyb20gJy4vUG9pbnRlcic7XG5cbmV4cG9ydCBjbGFzcyBBVExSZXF1ZXN0IHtcbiAgdXJsT2JqZWN0OiB1cmwuVXJsO1xuICB1cmw6IHN0cmluZztcblxuICBzdXBlckFnZW50UmVxdWVzdDogU3VwZXJBZ2VudFJlcXVlc3Q7XG4gIHN1cGVyQWdlbnRSZXNwb25zZTogUmVzcG9uc2U7XG5cbiAgcHJpdmF0ZSBmbGF0UHJvbWlzZSA9IGZsYXRQcm9taXNlKCk7XG5cbiAgcHJvbWlzZTogUHJvbWlzZTxSZXNwb25zZT4gPSB0aGlzLmZsYXRQcm9taXNlLnByb21pc2U7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHRlc3Q6IEFUTFRlc3QpIHtcblxuICB9XG5cbiAgcnVuKCk6IFByb21pc2U8UmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5fcnVuKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5mbGF0UHJvbWlzZS5yZWplY3RlcihlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvbWlzZTtcbiAgfVxuXG4gIHByaXZhdGUgX3J1bigpIHtcbiAgICB0aGlzLnVybE9iamVjdCA9IHVybC5wYXJzZSh0aGlzLnRlc3QudXJpLCB0cnVlKTtcblxuICAgIHRoaXMudXJsT2JqZWN0LnF1ZXJ5ID0gdGhpcy51cmxPYmplY3QucXVlcnkgfHwge307XG5cbiAgICBpZiAodGhpcy50ZXN0LnJlcXVlc3QucXVlcnlQYXJhbWV0ZXJzKSB7XG4gICAgICBpZiAoJ3NlYXJjaCcgaW4gdGhpcy51cmxPYmplY3QpXG4gICAgICAgIGRlbGV0ZSB0aGlzLnVybE9iamVjdC5zZWFyY2g7XG5cbiAgICAgIGxldCBxc1BhcmFtcyA9IGNsb25lT2JqZWN0VXNpbmdQb2ludGVycyh0aGlzLnRlc3QucmVxdWVzdC5xdWVyeVBhcmFtZXRlcnMsIHRoaXMudGVzdC5zdWl0ZS5BVEwub3B0aW9ucy52YXJpYWJsZXMpO1xuXG4gICAgICBmb3IgKGxldCBpIGluIHFzUGFyYW1zKSB7XG4gICAgICAgIGxldCB0eXBlT2ZWYWx1ZSA9IHR5cGVvZiBxc1BhcmFtc1tpXTtcblxuICAgICAgICBpZiAodHlwZU9mVmFsdWUgPT0gJ3VuZGVmaW5lZCcpIGNvbnRpbnVlO1xuXG4gICAgICAgIGlmICh0eXBlT2ZWYWx1ZSAhPSAnc3RyaW5nJyAmJiB0eXBlT2ZWYWx1ZSAhPSAnbnVtYmVyJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk9ubHkgc3RyaW5ncyBhbmQgbnVtYmVycyBhcmUgYWxsb3dlZCBvbiBxdWVyeVBhcmFtZXRlcnMuIFwiICsgaSArIFwiPVwiICsgaW5zcGVjdChxc1BhcmFtc1tpXSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy51cmxPYmplY3QucXVlcnlbaV0gPSBxc1BhcmFtc1tpXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGxldCBpIGluIHRoaXMudGVzdC51cmlQYXJhbWV0ZXJzKSB7XG4gICAgICBsZXQgdmFsdWUgPSBudWxsO1xuXG4gICAgICBpZiAodGhpcy50ZXN0LnVyaVBhcmFtZXRlcnNbaV0gaW5zdGFuY2VvZiBQb2ludGVyKSB7XG4gICAgICAgIHZhbHVlID0gdGhpcy50ZXN0LnVyaVBhcmFtZXRlcnNbaV0uZ2V0KHRoaXMudGVzdC5zdWl0ZS5BVEwub3B0aW9ucy52YXJpYWJsZXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFsdWUgPSB0aGlzLnRlc3QudXJpUGFyYW1ldGVyc1tpXTtcbiAgICAgIH1cblxuICAgICAgbGV0IHR5cGVPZlZhbHVlID0gdHlwZW9mIHZhbHVlO1xuXG4gICAgICBpZiAodHlwZU9mVmFsdWUgIT0gJ3N0cmluZycgJiYgdHlwZU9mVmFsdWUgIT0gJ251bWJlcicpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBzdHJpbmdzIGFuZCBudW1iZXJzIGFyZSBhbGxvd2VkIG9uIHVyaVBhcmFtZXRlcnMuIFwiICsgaSArIFwiPVwiICsgaW5zcGVjdCh2YWx1ZSkpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnVybE9iamVjdC5wYXRobmFtZSA9IHRoaXMudXJsT2JqZWN0LnBhdGhuYW1lLnJlcGxhY2UobmV3IFJlZ0V4cChcIntcIiArIGkgKyBcIn1cIiwgXCJnXCIpLCBmdW5jdGlvbiAoZnVsbHRleHQsIG1hdGNoKSB7XG4gICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIFRPRE8gTWV0aG9kIFVSSSBJbnRlcnBvbGF0aW9uXG4gICAgfVxuXG4gICAgdGhpcy51cmwgPSB1cmwuZm9ybWF0KHRoaXMudXJsT2JqZWN0KTtcblxuXG4gICAgbGV0IHJlcTogU3VwZXJBZ2VudFJlcXVlc3QgPSB0aGlzLnN1cGVyQWdlbnRSZXF1ZXN0ID0gdGhpcy50ZXN0LnN1aXRlLkFUTC5hZ2VudFt0aGlzLnRlc3QubWV0aG9kLnRvTG93ZXJDYXNlKCldKHRoaXMudXJsKTtcblxuICAgIC8vIHdlIG11c3Qgc2VuZCBzb21lIGRhdGEuLlxuICAgIGlmICh0aGlzLnRlc3QucmVxdWVzdCkge1xuICAgICAgaWYgKHRoaXMudGVzdC5yZXF1ZXN0LmhlYWRlcnMpIHtcbiAgICAgICAgbGV0IGhlYWRlcnMgPSBjbG9uZU9iamVjdFVzaW5nUG9pbnRlcnModGhpcy50ZXN0LnJlcXVlc3QuaGVhZGVycywgdGhpcy50ZXN0LnN1aXRlLkFUTC5vcHRpb25zLnZhcmlhYmxlcyk7XG5cbiAgICAgICAgZm9yIChsZXQgaCBpbiBoZWFkZXJzKSB7XG4gICAgICAgICAgcmVxLnNldChoLCBoZWFkZXJzW2hdID09IHVuZGVmaW5lZCA/ICcnIDogaGVhZGVyc1toXS50b1N0cmluZygpKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy50ZXN0LnJlcXVlc3QuanNvbikge1xuICAgICAgICBsZXQgZGF0YSA9IGNsb25lT2JqZWN0VXNpbmdQb2ludGVycyh0aGlzLnRlc3QucmVxdWVzdC5qc29uLCB0aGlzLnRlc3Quc3VpdGUuQVRMLm9wdGlvbnMudmFyaWFibGVzKTtcbiAgICAgICAgLy8gICAgICAgICAgcmVxdWVzdEhvbGRlci5jdHguUkVRVUVTVC5ib2R5ID0gZGF0YTtcbiAgICAgICAgcmVxLnNlbmQoZGF0YSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnRlc3QucmVxdWVzdC5hdHRhY2gpIHtcbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovXG4gICAgICAgIGlmICghdGhpcy50ZXN0LnN1aXRlLkFUTC5vcHRpb25zLnBhdGgpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJhdHRhY2ggaXMgbm90IGFsbG93ZWQgdXNpbmcgUkFXIGRlZmluaXRpb25zXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaSBpbiB0aGlzLnRlc3QucmVxdWVzdC5hdHRhY2gpIHtcbiAgICAgICAgICBsZXQgY3VycmVudEF0dGFjaG1lbnQgPSB0aGlzLnRlc3QucmVxdWVzdC5hdHRhY2hbaV07XG4gICAgICAgICAgcmVxLmF0dGFjaChjdXJyZW50QXR0YWNobWVudC5rZXksIHBhdGgucmVzb2x2ZSh0aGlzLnRlc3Quc3VpdGUuQVRMLm9wdGlvbnMucGF0aCwgY3VycmVudEF0dGFjaG1lbnQudmFsdWUpKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy50ZXN0LnJlcXVlc3QuZm9ybSkge1xuICAgICAgICByZXEudHlwZSgnZm9ybScpO1xuXG4gICAgICAgIGZvciAobGV0IGkgaW4gdGhpcy50ZXN0LnJlcXVlc3QuZm9ybSkge1xuICAgICAgICAgIGxldCBjdXJyZW50QXR0YWNobWVudCA9IGNsb25lT2JqZWN0VXNpbmdQb2ludGVycyh0aGlzLnRlc3QucmVxdWVzdC5mb3JtW2ldLCB0aGlzLnRlc3Quc3VpdGUuQVRMLm9wdGlvbnMudmFyaWFibGVzKTtcbiAgICAgICAgICByZXEuZmllbGQoY3VycmVudEF0dGFjaG1lbnQua2V5LCBjdXJyZW50QXR0YWNobWVudC52YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMudGVzdC5yZXF1ZXN0LnVybGVuY29kZWQpIHtcbiAgICAgICAgcmVxLnNlbmQoY2xvbmVPYmplY3RVc2luZ1BvaW50ZXJzKHRoaXMudGVzdC5yZXF1ZXN0LnVybGVuY29kZWQsIHRoaXMudGVzdC5zdWl0ZS5BVEwub3B0aW9ucy52YXJpYWJsZXMpKTtcbiAgICAgIH1cblxuICAgICAgLy8gVE9ETyBhZGQgUkFXIGJvZHksIGFkZCBlbHNlaWZzIHZhbGlkYXRpb25zXG4gICAgfVxuXG5cbiAgICByZXEuZW5kKChlcnIsIHJlcykgPT4ge1xuICAgICAgdGhpcy5zdXBlckFnZW50UmVzcG9uc2UgPSByZXM7XG5cbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmxhdFByb21pc2UucmVqZWN0ZXIoZXJyKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuZmxhdFByb21pc2UucmVzb2x2ZXIocmVzKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlcGVuZGVuY3lGYWlsZWQoKSB7XG4gICAgdGhpcy5mbGF0UHJvbWlzZS5yZWplY3RlcihuZXcgRXJyb3IoJ0RlcGVuZGVuY3kgZmFpbGVkLCBza2lwcGluZyByZXF1ZXN0LicpKTtcbiAgfVxufSJdfQ==